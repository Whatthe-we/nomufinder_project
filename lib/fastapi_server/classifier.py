import google.generativeai as genai
import os
import random
from dotenv import load_dotenv
from fastapi import FastAPI, Query
from fastapi import APIRouter
from pydantic import BaseModel

# ğŸ” í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()
api_key = os.getenv("GOOGLE_API_KEY")
if not api_key:
    raise Exception("âŒ GOOGLE_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.")

genai.configure(api_key=api_key)
model_name = "models/gemini-1.5-pro-latest"
model = genai.GenerativeModel(model_name=model_name)

router = APIRouter()

# âœ… ì‚¬ìš©ì ì…ë ¥ìš© ëª¨ë¸
class UserInput(BaseModel):
    text: str

# âœ… ì¹´í…Œê³ ë¦¬ë³„ Few-shot ì˜ˆì œ ëª©ë¡ (ì „ì²´ 90ë¬¸ì¥ ë°˜ì˜)
fewshot_examples = [
    # ì‚¬ì—…ì£¼ìš© (ì¹´í…Œê³ ë¦¬ë³„ 5ê°œ)
    ("ì§ì› ì¸ì‚¬í‰ê°€ ì‹œìŠ¤í…œ ê°œì„ ì´ í•„ìš”í•´ìš”", "ê¸°ì—…ìë¬¸"),
    ("ì¡°ì§ ê°œí¸ì— ë”°ë¥¸ ë²•ë¥  ìë¬¸ì„ ë°›ê³  ì‹¶ìŠµë‹ˆë‹¤", "ê¸°ì—…ìë¬¸"),
    ("ì‚¬ë‚´ ê·œì • ê°œì •ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤", "ê¸°ì—…ìë¬¸"),
    ("í•´ê³  í†µë³´ ì „ ë²•ì  ì ˆì°¨ë¥¼ ì•Œê³  ì‹¶ìŠµë‹ˆë‹¤", "ê¸°ì—…ìë¬¸"),
    ("íœ´ê²Œì‹œê°„ ì„¤ì •ì— ëŒ€í•´ ë¬¸ì˜ë“œë ¤ìš”", "ê¸°ì—…ìë¬¸"),
    ("ì§ë¬´ë¶„ì„ì„ ìœ„í•œ ì „ë¬¸ ì»¨ì„¤íŒ…ì„ ë°›ê³  ì‹¶ì–´ìš”", "ì»¨ì„¤íŒ…"),
    ("ì‚¬ë‚´ ë³µì§€ ì œë„ ê°œì„ ì„ ìœ„í•œ ì¡°ì–¸ì´ í•„ìš”í•´ìš”", "ì»¨ì„¤íŒ…"),
    ("ì¸ì‚¬ ê´€ë¦¬ ë°©ì•ˆì— ëŒ€í•´ ì™¸ë¶€ ì»¨ì„¤íŒ…ì„ ë°›ê³  ì‹¶ìŠµë‹ˆë‹¤", "ì»¨ì„¤íŒ…"),
    ("ê²½ì˜ì„±ê³¼ í‰ê°€ ë°©ë²•ì„ ë°”ê¾¸ê³  ì‹¶ìŠµë‹ˆë‹¤", "ì»¨ì„¤íŒ…"),
    ("ì§ê¸‰ì²´ê³„ë¥¼ ì •ë¹„í•˜ë ¤ê³  í•©ë‹ˆë‹¤", "ì»¨ì„¤íŒ…"),
    ("ê¸‰ì—¬ ê³„ì‚°ì„ ì™¸ì£¼í™”í•˜ê³  ì‹¶ì–´ìš”", "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹±"),
    ("í‡´ì§ê¸ˆ ì§€ê¸‰ ì—…ë¬´ë¥¼ ì™¸ë¶€ì— ë§¡ê¸°ê³  ì‹¶ìŠµë‹ˆë‹¤", "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹±"),
    ("ë³µì¡í•œ ê¸‰ì—¬ ì²˜ë¦¬ë¥¼ ì™¸ë¶€ì—ì„œ ë„ì™€ì¤¬ìœ¼ë©´ í•©ë‹ˆë‹¤", "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹±"),
    ("ì‚¬ë‚´ ê¸‰ì—¬ ì‚°ì • ê¸°ì¤€ì„ ê²€í† ë°›ê³  ì‹¶ì–´ìš”", "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹±"),
    ("ê¸‰ì—¬ ì§€ê¸‰ê³¼ ê´€ë ¨ëœ ë¯¼ì›ì´ ë§ì•„ ìë¬¸ì´ í•„ìš”í•´ìš”", "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹±"),
    ("ë…¸ì¡°ì™€ì˜ ë‹¨ì²´í˜‘ì•½ ì²´ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤", "ë…¸ë™ì¡°í•©"),
    ("íŒŒì—… ëŒ€ì‘ ë°©ì•ˆì— ëŒ€í•´ ë…¼ì˜í•˜ê³  ì‹¶ì–´ìš”", "ë…¸ë™ì¡°í•©"),
    ("ë…¸ì¡° ì„¤ë¦½ì— ëŒ€í•œ ë²•ì  ëŒ€ì‘ì´ í•„ìš”í•´ìš”", "ë…¸ë™ì¡°í•©"),
    ("ìŸì˜í–‰ìœ„ ë°œìƒ ì‹œ ì ˆì°¨ë¥¼ ì•Œê³  ì‹¶ìŠµë‹ˆë‹¤", "ë…¸ë™ì¡°í•©"),
    ("ë…¸ì‚¬ í˜‘ìƒ ì¤‘ ì¤‘ì¬ê°€ í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤", "ë…¸ë™ì¡°í•©"),
    ("ì‚°ì¬ë³´í—˜ ê´€ë ¨ êµìœ¡ì„ ì§ì›ì—ê²Œ ì œê³µí•˜ê³  ì‹¶ì–´ìš”", "ì‚°ì—…ì¬í•´"),
    ("ì‘ì—…ì¥ ë‚´ ì•ˆì „ ê¸°ì¤€ì„ ì ê²€ë°›ê³  ì‹¶ìŠµë‹ˆë‹¤", "ì‚°ì—…ì¬í•´"),
    ("ì‚°ì—…ì¬í•´ ì˜ˆë°© ëŒ€ì±…ì„ ë§ˆë ¨í•˜ê³  ì‹¶ì–´ìš”", "ì‚°ì—…ì¬í•´"),
    ("ìµœê·¼ ì‚¬ê³  ì´í›„ ì ˆì°¨ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤", "ì‚°ì—…ì¬í•´"),
    ("ì‚°ì¬ ì‹ ê³  ëˆ„ë½ì— ëŒ€í•œ ì±…ì„ì´ ê¶ê¸ˆí•´ìš”", "ì‚°ì—…ì¬í•´"),

    # ê·¼ë¡œììš© (ì¹´í…Œê³ ë¦¬ë³„ 5ê°œ)
    ("í‡´ì‚¬í–ˆëŠ”ë° ë§ˆì§€ë§‰ ì›”ê¸‰ì„ ì•ˆ ì¤˜ìš”", "ì„ê¸ˆì²´ë¶ˆ"),
    ("ìˆ˜ë‹¹ ì—†ì´ ì•¼ê·¼ì„ ê³„ì† ì‹œí‚µë‹ˆë‹¤", "ì„ê¸ˆì²´ë¶ˆ"),
    ("í‡´ì§ê¸ˆì„ ì ê²Œ ë°›ì•˜ì–´ìš”", "ì„ê¸ˆì²´ë¶ˆ"),
    ("ì£¼íœ´ìˆ˜ë‹¹ì„ í•œ ë²ˆë„ ë°›ì€ ì ì´ ì—†ìŠµë‹ˆë‹¤", "ì„ê¸ˆì²´ë¶ˆ"),
    ("ê¸‰ì—¬ ì¼ë¶€ê°€ í˜„ë¬¼ë¡œ ì§€ê¸‰ë¼ìš”", "ì„ê¸ˆì²´ë¶ˆ"),
    ("ì¶œê·¼í–ˆë”ë‹ˆ í•´ê³  í†µë³´ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤", "ë¶€ë‹¹í•´ê³ "),
    ("íœ´ê°€ ë‹¤ë…€ì™”ë”ë‹ˆ ê³„ì•½ì„ í•´ì§€ë‹¹í–ˆì–´ìš”", "ë¶€ë‹¹í•´ê³ "),
    ("í‡´ì‚¬ ê°•ìš”ë¥¼ ë°›ê³  ìˆìŠµë‹ˆë‹¤", "ë¶€ë‹¹í•´ê³ "),
    ("ê°ì •ì ì¸ ì´ìœ ë¡œ ì˜ë ¸ìŠµë‹ˆë‹¤", "ë¶€ë‹¹í•´ê³ "),
    ("ê·¼ë¡œê³„ì•½ì„œì™€ ë‹¤ë¥´ê²Œ ê³„ì•½ ì¢…ë£Œëì–´ìš”", "ë¶€ë‹¹í•´ê³ "),
    ("ê³„ì•½ì„œë¥¼ ì“°ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤", "ê·¼ë¡œê³„ì•½"),
    ("ê³„ì•½ì„œì— ë¶ˆë¦¬í•œ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤", "ê·¼ë¡œê³„ì•½"),
    ("ê·¼ë¡œì‹œê°„ì´ ê³„ì•½ì„œì™€ ë‹¬ë¼ìš”", "ê·¼ë¡œê³„ì•½"),
    ("ê³„ì•½ ë‚´ìš© ë³€ê²½ì„ ì‚¬ì „ ê³ ì§€ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤", "ê·¼ë¡œê³„ì•½"),
    ("ê³ ìš©í˜•íƒœë¥¼ ë‹¤ë¥´ê²Œ ê¸°ì¬í–ˆìŠµë‹ˆë‹¤", "ê·¼ë¡œê³„ì•½"),
    ("ì•¼ê·¼ì„ í•´ë„ ìˆ˜ë‹¹ì´ ì—†ì–´ìš”", "ê·¼ë¬´ì¡°ê±´"),
    ("íœ´ê²Œì‹œê°„ì´ ë³´ì¥ë˜ì§€ ì•Šì•„ìš”", "ê·¼ë¬´ì¡°ê±´"),
    ("íœ´ì¼ê·¼ë¬´ ì‹œ ëŒ€ì²´íœ´ì¼ë„ ì—†ìŠµë‹ˆë‹¤", "ê·¼ë¬´ì¡°ê±´"),
    ("ê·¼ë¡œì‹œê°„ì´ ê³„ì† ëŠ˜ì–´ë‚˜ê³  ìˆìŠµë‹ˆë‹¤", "ê·¼ë¬´ì¡°ê±´"),
    ("ê·¼ë¬´í™˜ê²½ì´ ë„ˆë¬´ ì—´ì•…í•©ë‹ˆë‹¤", "ê·¼ë¬´ì¡°ê±´"),
    ("ë¶€ì„œì¥ì´ ì„±í¬ë¡± ë°œì–¸ì„ í–ˆìŠµë‹ˆë‹¤", "ì§ì¥ ë‚´ ì„±í¬ë¡±"),
    ("ìƒì‚¬ê°€ ì™¸ëª¨ë¡œ í‰ê°€í•´ìš”", "ì§ì¥ ë‚´ ì„±í¬ë¡±"),
    ("íšŒì‹ ìë¦¬ì—ì„œ ì„±ì  ë†ë‹´ì„ ë“¤ì—ˆìŠµë‹ˆë‹¤", "ì§ì¥ ë‚´ ì„±í¬ë¡±"),
    ("í”¼í•´ ì‚¬ì‹¤ì„ ë§í–ˆë”ë‹ˆ ë¬´ì‹œë‹¹í–ˆìŠµë‹ˆë‹¤", "ì§ì¥ ë‚´ ì„±í¬ë¡±"),
    ("ì„±í¬ë¡± ì‹ ê³  í›„ ì˜¤íˆë ¤ ë¶ˆì´ìµì„ ë°›ì•˜ì–´ìš”", "ì§ì¥ ë‚´ ì„±í¬ë¡±"),
    ("ì¶œì‚° í›„ ë³µì§í–ˆë”ë‹ˆ ë¶€ì„œê°€ ë°”ë€Œì—ˆìŠµë‹ˆë‹¤", "ì§ì¥ ë‚´ ì°¨ë³„"),
    ("ìœ¡ì•„íœ´ì§ í›„ ë³µê·€í–ˆë”ë‹ˆ ìë¦¬ ì´ë™ëì–´ìš”", "ì§ì¥ ë‚´ ì°¨ë³„"),
    ("ì„ì‹ í•˜ì ì—…ë¬´ ë°°ì œê°€ ëìŠµë‹ˆë‹¤", "ì§ì¥ ë‚´ ì°¨ë³„"),
    ("ì •ê·œì§ê³¼ ë¹„ì •ê·œì§ ì°¨ë³„ì´ ì‹¬í•´ìš”", "ì§ì¥ ë‚´ ì°¨ë³„"),
    ("ë‚¨ë…€ ê°„ ê¸‰ì—¬ ì°¨ì´ê°€ ì¡´ì¬í•©ë‹ˆë‹¤", "ì§ì¥ ë‚´ ì°¨ë³„"),
    ("ì‚¬ì ì¸ ì´ìœ ë¡œ íŒ€ì¥ì´ ê´´ë¡­í˜€ìš”", "ì§ì¥ ë‚´ ê´´ë¡­í˜"),
    ("ìƒì‚¬ê°€ ê³„ì† ì†Œë¦¬ë¥¼ ì§€ë¦…ë‹ˆë‹¤", "ì§ì¥ ë‚´ ê´´ë¡­í˜"),
    ("ì—…ë¬´ë¥¼ ì¼ë¶€ëŸ¬ ê³¼ë„í•˜ê²Œ ì¤˜ìš”", "ì§ì¥ ë‚´ ê´´ë¡­í˜"),
    ("ë™ë£Œë“¤ê³¼ì˜ ë‹¨ì ˆì„ ìœ ë„í•©ë‹ˆë‹¤", "ì§ì¥ ë‚´ ê´´ë¡­í˜"),
    ("í‡´ê·¼ í›„ì—ë„ ì—…ë¬´ ì§€ì‹œê°€ ì˜µë‹ˆë‹¤", "ì§ì¥ ë‚´ ê´´ë¡­í˜"),
    ("ì‘ì—… ì¤‘ ì‚¬ê³ ê°€ ë‚¬ëŠ”ë° ì‚°ì¬ ì²˜ë¦¬ê°€ ì•ˆë¼ìš”", "ì‚°ì—…ì¬í•´"),
    ("ì¶œí‡´ê·¼ ì¤‘ ì‚¬ê³ ê°€ ë°œìƒí–ˆì–´ìš”", "ì‚°ì—…ì¬í•´"),
    ("ì‚°ì—…ì¬í•´ ì‹ ì²­ ì ˆì°¨ë¥¼ ì•Œê³  ì‹¶ìŠµë‹ˆë‹¤", "ì‚°ì—…ì¬í•´"),
    ("ì‚°ì¬ ì¹˜ë£Œë¹„ê°€ ì§€ì›ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤", "ì‚°ì—…ì¬í•´"),
    ("ì‚°ì¬ ì¸ì •ì´ ê±°ì ˆëì–´ìš”", "ì‚°ì—…ì¬í•´"),
]

# âœ… ë¶„ë¥˜ìš© í•¨ìˆ˜
def classify_text_with_gemini(user_input: str) -> str:
    random.shuffle(fewshot_examples)
    shots = "\n".join([f"ë¬¸ì¥: {ex}\nì¹´í…Œê³ ë¦¬: {cat}" for ex, cat in fewshot_examples[:10]])
    prompt = f"""
    ë‹¤ìŒ ë¬¸ì¥ì„ ì•„ë˜ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”:
    [ê¸°ì—…ìë¬¸, ì»¨ì„¤íŒ…, ê¸‰ì—¬ ì•„ì›ƒì†Œì‹±, ì„ê¸ˆì²´ë¶ˆ, ë¶€ë‹¹í•´ê³ , ì§ì¥ ë‚´ ê´´ë¡­í˜, ì§ì¥ ë‚´ ì„±í¬ë¡±, ë…¸ë™ì¡°í•©, ì‚°ì—…ì¬í•´,
    ë¶€ë‹¹í•´ê³ , ë¶€ë‹¹ì§•ê³„, ê·¼ë¡œê³„ì•½, ê·¼ë¬´ì¡°ê±´, ì§ì¥ ë‚´ ì„±í¬ë¡±, ì§ì¥ ë‚´ ì°¨ë³„, ì„ê¸ˆì²´ë¶ˆ, ì§ì¥ ë‚´ ê´´ë¡­í˜, ì‚°ì—…ì¬í•´, ë…¸ë™ì¡°í•©]

    {shots}

    ë¬¸ì¥: {user_input}
    ì¹´í…Œê³ ë¦¬:
    """
    try:
        response = model.generate_content(prompt)
        if response.candidates and response.candidates[0].content.parts:
            text = response.candidates[0].content.parts[0].text.strip()
            for line in text.splitlines():
                if "ì¹´í…Œê³ ë¦¬:" in line:
                    return line.split("ì¹´í…Œê³ ë¦¬:")[1].strip()
        return "ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    except Exception as e:
        print("âŒ Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", e)
        return f"ë¶„ë¥˜ ì‹¤íŒ¨: {e}"

# âœ… ë¶„ë¥˜ API
@router.post("/classify")
async def classify_endpoint(user_input: UserInput):
    result = classify_text_with_gemini(user_input.text)
    return {"category": result}

# âœ… ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©
if __name__ == "__main__":
    test_inputs = [
        "ê¸‰ì—¬ ì¼ë¶€ê°€ í˜„ë¬¼ë¡œ ì§€ê¸‰ë¼ìš”",
        "ì‚¬ë‚´ ì¸ì‚¬í‰ê°€ ì‹œìŠ¤í…œì„ ê°œì„ í•˜ê³  ì‹¶ì–´ìš”",
    ]
    for text in test_inputs:
        print(f"ì…ë ¥: {text} â†’ ë¶„ë¥˜ ê²°ê³¼: {classify_text_with_gemini(text)}")