import os
import random
from fastapi import APIRouter
from pydantic import BaseModel
from typing import Optional
from openai import OpenAI

# 라우터 초기화
router = APIRouter()

# 전역 키 설정
client: OpenAI = None

def set_openai_api_key(api_key: str):
    global client
    client = OpenAI(api_key=api_key)

# 사용자 입력 모델
class UserInput(BaseModel):
    text: str

def set_model(gemini_model):
    """main.py에서 초기화된 모델을 설정하는 함수"""
    global model
    model = gemini_model

# 카테고리별 자동완성 키워드 맵
autocomplete_map = {
		# 근로 카테고리
    "부당해고": ["해고", "권고사직", "계약종료", "수습해고", "출근정지", "징계", "불법해고", "무단결근", "해고통보", "부당해고구제신청"],
    "부당징계": ["징계", "정직", "감봉", "해고", "경고", "징계위원회", "불이익", "비정상징계", "징계처분", "불법징계"],
    "근로계약": ["근로계약서", "계약기간", "근로조건", "계약서 미작성", "계약변경", "근로계약 해지", "근로시간", "연차", "정규직", "기간제"],
    "근무조건": ["근로시간", "주휴수당", "휴가", "근무시간", "교대근무", "초과근무", "비정규직", "정규직", "유급휴가", "산재보상"],
    "직장 내 성희롱": ["성희롱", "성추행", "언어폭력", "성적언급", "성적이해", "성희롱 예방", "직장 내 폭력", "성적대상", "불법촬영", "성희롱신고"],
    "직장 내 괴롭힘": ["괴롭힘", "폭력", "언어폭력", "모욕", "따돌림", "고립", "감정노동", "폭행", "스트레스", "고소"],
    "직장 내 차별": ["차별", "성차별", "연령차별", "성별차별", "직급차별", "직무차별", "종교차별", "고용차별", "평등", "차별철폐"],
    "임금/퇴직금": ["임금체불", "급여 미지급", "지연 지급", "최저임금", "근로계약 미이행", "연장근로 수당 미지급", "퇴직금 미지급", "임금체불 신고", "임금체불 처리", "법정 급여"],
    "산업재해": ["산재", "근로자 재해", "산업재해 보상", "재해 보상", "직업병", "산재보험", "산재처리", "산업사고", "재해 예방법", "산재 사고"],
    "노동조합": ["노동조합", "파업", "임금협상", "노조 활동", "노동권", "노동자 권리", "노동조합 설립", "노조 파업", "노조 대표", "조합원"],

    # 사업주 카테고리
    "기업자문": ["경영자문", "법률자문", "세무자문", "경영 컨설팅", "재무 자문", "전략 자문", "사업 컨설팅", "기업 운영 자문", "투자 자문", "M&A 자문"],
    "컨설팅": ["경영 컨설팅", "IT 컨설팅", "인사 컨설팅", "조직 컨설팅", "프로젝트 관리", "경쟁 분석", "시장 조사", "비즈니스 전략", "경영 혁신", "인프라 구축"],
    "급여 아웃소싱": ["급여 관리", "급여 대행", "급여 계산", "세금 신고", "사회보험", "급여 지급", "급여 시스템", "급여 아웃소싱 계약", "급여 보고", "급여 처리"]
}

# OpenAI 분류 함수
def classify_text_with_openai(user_input: str) -> str:
    """텍스트를 분석하여 적절한 카테고리로 분류하는 함수"""

    # 퓨샷 예시 (fewshot_examples)
    fewshot_examples = [
        # ------------------------- 사업주용 -------------------------
        # 부당해고
        '"무단결근한 직원의 해고가 가능한지 궁금해요" -> 부당해고',
        '"신규 사업 개시로 인해 인력 구조조정이 필요해요" -> 부당해고',
        '"수습 기간 중 해고 시 주의할 점이 있나요?" -> 부당해고',
        '"업무 능력 부족으로 해고하려면 어떤 절차가 필요하나요?" -> 부당해고',
        '"직원에게 권고사직을 제안하고 싶은데 괜찮을까요?" -> 부당해고',

        # 부당징계
        '"지각이 잦은 직원에게 징계 가능한가요?" -> 부당징계',
        '"회사 이미지 손상으로 인한 징계 절차를 알고 싶어요" -> 부당징계',
        '"경고장 발부 없이 징계 가능한가요?" -> 부당징계',
        '"징계 사유로 사적 SNS 활동이 포함될 수 있나요?" -> 부당징계',
        '"동료 간 불화로 인한 징계 절차가 궁금해요" -> 부당징계',

        # 임금체불
        '"급여 이체가 지연되었는데 어떻게 대응해야 할까요?" -> 임금/퇴직금',
        '"연장근로 수당을 미지급한 상황입니다" -> 임금/퇴직금',
        '"임금 산정 기준 변경 관련 문의입니다" -> 임금/퇴직금',
        '"퇴직금 정산 기준이 헷갈립니다" -> 임금/퇴직금',
        '"전 직원의 임금 지급 누락 건 처리 방법이 궁금합니다" -> 임금/퇴직금',

        # 직장내 성희롱
        '"성희롱 신고가 접수됐을 때 기업의 책임은?" -> 직장 내 성희롱',
        '"가해자로 지목된 직원을 어떻게 처리해야 할까요?" -> 직장 내 성희롱',
        '"성희롱 예방 교육을 의무적으로 해야 하나요?" -> 직장 내 성희롱',
        '"사내 성희롱 조사가 필요한 상황입니다" -> 직장 내 성희롱',
        '"2차 가해를 방지하려면 어떤 조치가 필요한가요?" -> 직장 내 성희롱',

        # 직장내 괴롭힘
        '"직원이 괴롭힘을 당했다고 주장해요" -> 직장 내 괴롭힘',
        '"부서장 간 갈등이 조직에 영향을 줍니다" -> 직장 내 괴롭힘',
        '"익명 제보에 대한 조사 의무가 있나요?" -> 직장 내 괴롭힘',
        '"괴롭힘 가해자에 대한 조치 가이드가 있나요?" -> 직장 내 괴롭힘',
        '"신고 이후 조직 분위기 관리를 어떻게 하나요?" -> 직장 내 괴롭힘',

        # 산업재해
        '"산재 발생 후 회사 책임 범위를 알고 싶어요" -> 산업재해',
        '"산업재해 발생 시 고용 유지 방법이 궁금합니다" -> 산업재해',
        '"안전 조치 미흡으로 인한 사고 발생 대응법은?" -> 산업재해',
        '"작업장 내 보호 장비 지급 기준은 어떻게 되나요?" -> 산업재해',
        '"산재보험 보상 외 추가 지원 방안이 있을까요?" -> 산업재해',

        # 노동조합
        '"노조가 단체행동을 예고했어요. 대응법이 있나요?" -> 노동조합',
        '"노조와의 단체교섭은 언제부터 시작해야 하나요?" -> 노동조합',
        '"노조 회의 시간이 근무시간에 포함되나요?" -> 노동조합',
        '"비조합원 직원이 불만을 제기합니다" -> 노동조합',
        '"노사협의회와 노조는 어떻게 다르죠?" -> 노동조합',

        # 기업자문
        '"직원 평가 기준을 새로 만들고 싶어요" -> 기업자문',
        '"내부 규정을 리뉴얼하려 합니다" -> 기업자문',
        '"기업 인사 시스템을 개선하고 싶어요" -> 기업자문',
        '"복잡한 인사관리 구조에 대해 자문받고 싶어요" -> 기업자문',
        '"근태 관리 시스템을 개선하고자 합니다" -> 기업자문',

        # 컨설팅
        '"근로자 만족도 조사 설계가 필요합니다" -> 컨설팅',
        '"인사제도 개선 프로젝트를 시작하려 해요" -> 컨설팅',
        '"노무 관련 외부 자문을 받고 싶어요" -> 컨설팅',
        '"외부 기관 컨설팅과 계약할 예정입니다" -> 컨설팅',
        '"회사의 HR 구조를 진단하고 싶어요" -> 컨설팅',

        # 급여 아웃소싱
        '"급여 시스템을 외부에 맡기려 합니다" -> 급여 아웃소싱',
        '"퇴직 정산을 자동화하고 싶어요" -> 급여 아웃소싱',
        '"외부 급여 컨설팅 업체 추천이 필요해요" -> 급여 아웃소싱',
        '"급여 관련 민원 처리를 외부에 위탁하고 싶어요" -> 급여 아웃소싱',
        '"복잡한 세금 신고를 아웃소싱하려 합니다" -> 급여 아웃소싱',

        # ------------------------- 근로자용 -------------------------
        # 부당해고
        '"정당한 이유 없이 해고 통보를 받았어요" -> 부당해고',
        '"이유 설명 없이 출근하지 말라고 했어요" -> 부당해고',
        '"재계약 거절이 부당한 해고인가요?" -> 부당해고',
        '"병가 중 해고 통보를 받았습니다" -> 부당해고',
        '"입사한 지 3개월 만에 해고됐어요" -> 부당해고',

        # 부당징계
        '"출근 태도 문제로 갑자기 징계를 받았어요" -> 부당징계',
        '"징계 전에 설명도 듣지 못했습니다" -> 부당징계',
        '"징계 사유가 너무 모호해요" -> 부당징계',
        '"동료와의 사소한 다툼으로 징계를 받았어요" -> 부당징계',
        '"경고장을 받은 후 바로 정직 처분됐어요" -> 부당징계',

        # 근로계약
        '"채용 시 설명과 다른 조건이 적혀있어요" -> 근로계약',
        '"정규직이라더니 계약직이었어요" -> 근로계약',
        '"계약 내용을 변경하면서 설명이 없었어요" -> 근로계약',
        '"근로계약서를 아직도 안 줬어요" -> 근로계약',
        '"근무 시작일 전 계약서를 썼어야 했던 거 아닌가요?" -> 근로계약',

        # 근무조건
        '"주말에 계속 근무하고 있는데 수당이 없어요" -> 근무조건',
        '"일과 중 휴게시간이 없습니다" -> 근무조건',
        '"출퇴근 시간이 너무 유동적이에요" -> 근무조건',
        '"근로시간 기록을 허위로 작성하라고 해요" -> 근무조건',
        '"무급 초과근무를 강요받고 있어요" -> 근무조건',

        # 직장내 성희롱
        '"상사가 외모에 대해 말해요" -> 직장 내 성희롱',
        '"회식 자리에서 성적인 농담을 들어야 했어요" -> 직장 내 성희롱',
        '"성희롱을 신고했더니 불이익을 받았어요" -> 직장 내 성희롱',
        '"지속적인 성희롱 발언으로 스트레스를 받고 있어요" -> 직장 내 성희롱',
        '"성적 언동이 반복돼요" -> 직장 내 성희롱',

        # 직장내 괴롭힘
        '"상사가 반복적으로 모욕적인 말을 해요" -> 직장 내 괴롭힘',
        '"부당하게 업무를 계속 떠넘겨요" -> 직장 내 괴롭힘',
        '"혼자 일하게 만들어요" -> 직장 내 괴롭힘',
        '"회의에서 의도적으로 발언 기회를 주지 않아요" -> 직장 내 괴롭힘',
        '"동료들 앞에서 계속 망신을 줘요" -> 직장 내 괴롭힘',

        # 직장내 차별
        '"나이 때문에 승진에서 제외됐어요" -> 직장 내 차별',
        '"남자 직원만 야근을 면제해줘요" -> 직장 내 차별',
        '"비정규직이라 불이익을 받고 있어요" -> 직장 내 차별',
        '"경력직과 신입에 대한 대우 차이가 심해요" -> 직장 내 차별',
        '"출산휴가 후 인사이동이 됐어요" -> 직장 내 차별',

        # 임금체불
        '"월급이 계속 지연되고 있어요" -> 임금/퇴직금',
        '"잔업수당을 한 번도 받은 적이 없어요" -> 임금/퇴직금',
        '"퇴직금이 제대로 정산되지 않았어요" -> 임금/퇴직금',
        '"연차수당이 지급되지 않았어요" -> 임금/퇴직금',
        '"임금 일부가 현물로 지급돼요" -> 임금/퇴직금',

        # 산업재해
        '"작업 중 다쳐도 산재 처리를 안 해줘요" -> 산업재해',
        '"출퇴근 중 사고인데 처리가 안 됩니다" -> 산업재해',
        '"산재 신청이 거절됐어요" -> 산업재해',
        '"치료비가 전액 본인 부담이에요" -> 산업재해',
        '"산재 신청 서류 작성이 어려워요" -> 산업재해',

        # 노동조합
        '"노조에 가입했더니 불이익을 받았어요" -> 노동조합',
        '"노조 활동을 제지받고 있어요" -> 노동조합',
        '"단체행동에 참여했다가 징계를 받았어요" -> 노동조합',
        '"노조 활동 시간이 줄었어요" -> 노동조합',
        '"회사가 노조를 무시해요" -> 노동조합',
    ]

    # 퓨샷 예시를 포함한 프롬프트 작성
    prompt = f"""
    다음 문장을 아래 카테고리 중 하나로 분류하세요:
    [부당해고, 부당징계, 근로계약, 근무조건, 직장 내 성희롱, 직장 내 괴롭힘, 직장 내 차별, 임금/퇴직금, 산업재해, 노동조합]

    예시:
    {chr(10).join(fewshot_examples)}

    문장: {user_input}
    카테고리:
    """

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3,
            max_tokens=50,
        )
        result = response.choices[0].message.content.strip()
        print(f"Predicted Category: {result}")
        return result.split(" ")[0]
    except Exception as e:
        print("❌ OpenAI API 오류:", e)
        return "분류 실패"

# FastAPI 분류 엔드포인트
@router.post("/classify")
async def classify_endpoint(user_input: UserInput):
    result = classify_text_with_openai(user_input.text)
    return {"category": result}