import os
import random
from fastapi import APIRouter
from pydantic import BaseModel
from typing import Optional
from openai import OpenAI
from datetime import datetime
import time

# ë¼ìš°í„° ì´ˆê¸°í™”
router = APIRouter()

# ì „ì—­ í‚¤ ì„¤ì •
client: OpenAI = None

def set_openai_api_key(api_key: str):
    global client
    client = OpenAI(api_key=api_key)

# ì‚¬ìš©ì ì…ë ¥ ëª¨ë¸
class UserInput(BaseModel):
    text: str

# ìë™ì™„ì„± í‚¤ì›Œë“œ ë§µ
autocomplete_map = {
    "ë¶€ë‹¹í•´ê³ ": ["í•´ê³ ", "ê¶Œê³ ì‚¬ì§", "ê¸°ê°„ì œ ê³„ì•½ ì¢…ë£Œ", "ìˆ˜ìŠµí•´ê³ ", "ì¶œê·¼ì •ì§€", "ì±„ìš©ì·¨ì†Œ", "ë¶ˆë²•í•´ê³ ", "ë¬´ë‹¨ê²°ê·¼", "í•´ê³ í†µë³´", "ë¶€ë‹¹í•´ê³ êµ¬ì œì‹ ì²­"],
    "ë¶€ë‹¹ì§•ê³„": ["ì§•ê³„", "ì •ì§", "ê°ë´‰", "í•´ê³ ", "ê²½ê³ ", "ì§•ê³„ìœ„ì›íšŒ", "ì§•ê³„ì‚¬ìœ  ë¯¸í†µë³´", "ì§•ê³„ì ˆì°¨ í•˜ì", "ì´ì¤‘ì§•ê³„", "ëŒ€ê¸°ë°œë ¹"],
    "ê·¼ë¡œê³„ì•½": ["ê·¼ë¡œê³„ì•½ì„œ ë¯¸ì‘ì„±", "ê³„ì•½ê¸°ê°„", "ê·¼ë¡œê³„ì•½ ì¡°ê±´ ë¶ˆì´í–‰", "ì„œë©´ ê³„ì•½ ë¯¸ì‘ì„±", "ê¸°ê°„ì œ ê³„ì•½ ì¢…ë£Œ", "ê·¼ë¡œê³„ì•½ í•´ì§€", "ë¬´ê¸°ê³„ì•½ì§ ì „í™˜", "ë¶ˆë¦¬í•œ ê³„ì•½ ì¡°ê±´", "ìˆ˜ìŠµ ê³„ì•½ì„œ", "ê³„ì•½ ì—°ì¥ ê±°ì ˆ"],
    "ê·¼ë¬´ì¡°ê±´": ["ê·¼ë¡œì‹œê°„", "ì£¼íœ´ìˆ˜ë‹¹ ë¯¸ì§€ê¸‰", "íœ´ê°€ ë¯¸ë¶€ì—¬", "ê·¼ë¡œì‹œê°„ ìœ„ë°˜", "êµëŒ€ê·¼ë¬´", "ì´ˆê³¼ê·¼ë¬´", "ë¹„ì •ê·œì§", "ì •ê·œì§", "ìœ ê¸‰íœ´ê°€", "ì´ˆê³¼ê·¼ë¬´ ê°•ìš”"],
    "ì§ì¥ë‚´ì„±í¬ë¡±": ["ì„±í¬ë¡±", "ì„±ì¶”í–‰", "ì„±ì ì–¸ê¸‰", "ì„±í¬ë¡± ì‹ ê³  ì ˆì°¨", "ì„±í¬ë¡± í”¼í•´ ì…ì¦", "ì„±í¬ë¡± í”¼í•´ì ë¶ˆì´ìµ", "ì„±í¬ë¡± ì˜ˆë°©êµìœ¡", "ì„±í¬ë¡± í‡´ì‚¬", "ë¶ˆë²•ì´¬ì˜", "ì„±í¬ë¡± 2ì°¨ ê°€í•´"],
    "ì§ì¥ë‚´ê´´ë¡­í˜": ["ê´´ë¡­í˜", "í­ë ¥", "ì–¸ì–´í­ë ¥", "ëª¨ìš•", "ë”°ëŒë¦¼", "ì—…ë¬´ ë°°ì œ", "ê°ì •ë…¸ë™", "ì‚¬ì ì¸ ì—…ë¬´ ê°•ìš”", "ìŠ¤íŠ¸ë ˆìŠ¤", "ê´´ë¡­í˜ í‡´ì‚¬"],
    "ì§ì¥ë‚´ì°¨ë³„": ["ì°¨ë³„", "ì„±ì°¨ë³„", "ë‚˜ì´ ì°¨ë³„", "ì„ì‹  í›„ ë¶ˆì´ìµ", "ì§ê¸‰ì°¨ë³„", "ì§ë¬´ì°¨ë³„", "ì¢…êµì°¨ë³„", "ë¹„ì •ê·œì§ ì°¨ë³„", "ì¥ì• ì¸ ì°¨ë³„", "ì—…ë¬´ ë°°ì • ì°¨ë³„"],
    "ì„ê¸ˆ/í‡´ì§ê¸ˆ": ["ì„ê¸ˆì²´ë¶ˆ", "ê¸‰ì—¬ ë¯¸ì§€ê¸‰", "ì§€ì—° ì§€ê¸‰", "ìµœì €ì„ê¸ˆ ìœ„ë°˜", "ê¸‰ì—¬ ì‚­ê°", "ì—°ì¥ê·¼ë¡œ ìˆ˜ë‹¹ ë¯¸ì§€ê¸‰", "í‡´ì§ê¸ˆ ë¯¸ì§€ê¸‰", "ì„ê¸ˆì²´ë¶ˆ ì§„ì •", "ì§€ê° ê³µì œ", "í‡´ì§ê¸ˆ ê³„ì‚°"],
    "ì‚°ì—…ì¬í•´": ["ì‚°ì¬", "ê·¼ë¡œì ì¬í•´", "ì‚°ì—…ì¬í•´ ë³´ìƒ", "ì¬í•´ ë³´ìƒ", "ì§ì—…ë³‘", "ì‚°ì¬ë³´í—˜", "ì‚°ì¬ì²˜ë¦¬", "ì¶œí‡´ê·¼ ì‚¬ê³ ", "ì¬í•´ ì˜ˆë°©ë²•", "ì‚°ì¬ ë³‘ê°€"],
    "ë…¸ë™ì¡°í•©": ["ë…¸ë™ì¡°í•©", "íŒŒì—…", "ì„ê¸ˆí˜‘ìƒ", "ë…¸ì¡° í™œë™ ë¶ˆì´ìµ", "ë…¸ë™ê¶Œ", "ë…¸ë™ì ê¶Œë¦¬", "ë…¸ë™ì¡°í•© ì„¤ë¦½", "ë…¸ì¡° íŒŒì—…", "ë…¸ì¡° ëŒ€í‘œ", "ì¡°í•©ì›"],
    "ê¸°ì—…ìë¬¸": ["ê²½ì˜ìë¬¸", "ë²•ë¥ ìë¬¸", "ì¸ì‚¬ê´€ë¦¬", "ê¸‰ì—¬ ì‹œìŠ¤í…œ êµ¬ì¶•", "ì†Œê·œëª¨ ì‚¬ì—…ì¥ ìë¬¸", "ì¸ì‚¬ ê·œì • ì •ë¹„", "ë…¸ë¬´ ê°ì‚¬ ëŒ€ì‘", "ê¸°ì—… ìš´ì˜ ìë¬¸", "ë…¸ì‚¬ í˜‘ìƒ ì „ëµ", "M&A ìë¬¸"],
    "ì»¨ì„¤íŒ…": ["ê²½ì˜ ì»¨ì„¤íŒ…", "IT ì»¨ì„¤íŒ…", "ì¸ì‚¬ ì»¨ì„¤íŒ…", "ì¡°ì§ ì»¨ì„¤íŒ…", "ESG", "í‰ê°€ì œë„ ë„ì…", "ì¸ì¬ ì±„ìš© ì „ëµ", "ì§ë¬´ë¶„ì„ ì»¨ì„¤íŒ…", "ì„±ê³¼ê´€ë¦¬ ë„ì…", "ì¡°ì§ ê°œí¸ ìë¬¸"],
    "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±": ["ê¸‰ì—¬ ê´€ë¦¬", "ê¸‰ì—¬ ëŒ€í–‰", "ê¸‰ì—¬ ê³„ì‚°", "ì„¸ê¸ˆ ì‹ ê³ ", "ì‚¬íšŒë³´í—˜", "ê¸‰ì—¬ ì§€ê¸‰", "ê¸‰ì—¬ ì‹œìŠ¤í…œ", "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹± ê³„ì•½", "4ëŒ€ë³´í—˜ ë° ì›ì²œì§•ìˆ˜", "ê¸‰ì—¬ ì²˜ë¦¬"]
}
# ì¹´í…Œê³ ë¦¬ ëª©ë¡
categories = list(autocomplete_map.keys())

# Few-shot ì˜ˆì‹œ (ê³µì‹ +
business_examples = [
    '"ë¬´ë‹¨ê²°ê·¼í•œ ì§ì›ì˜ í•´ê³ ê°€ ê°€ëŠ¥í•œì§€ ê¶ê¸ˆí•´ìš”" -> ë¶€ë‹¹í•´ê³ ',
    '"ì‹ ê·œ ì‚¬ì—… ê°œì‹œë¡œ ì¸í•´ ì¸ë ¥ êµ¬ì¡°ì¡°ì •ì´ í•„ìš”í•´ìš”" -> ë¶€ë‹¹í•´ê³ ',
    '"ì§€ê°ì´ ì¦ì€ ì§ì›ì—ê²Œ ì§•ê³„ ê°€ëŠ¥í•œê°€ìš”?" -> ë¶€ë‹¹ì§•ê³„',
    '"ê¸‰ì—¬ ì´ì²´ê°€ ì§€ì—°ë˜ì—ˆëŠ”ë° ì–´ë–»ê²Œ ëŒ€ì‘í•´ì•¼ í• ê¹Œìš”?" -> ì„ê¸ˆ/í‡´ì§ê¸ˆ',
    '"ì„±í¬ë¡± ì‹ ê³ ê°€ ì ‘ìˆ˜ëì„ ë•Œ ê¸°ì—…ì˜ ì±…ì„ì€?" -> ì§ì¥ë‚´ì„±í¬ë¡±',
    '"ì§ì›ì´ ê´´ë¡­í˜ì„ ë‹¹í–ˆë‹¤ê³  ì£¼ì¥í•´ìš”" -> ì§ì¥ë‚´ê´´ë¡­í˜',
    '"ì‚°ì¬ ë°œìƒ í›„ íšŒì‚¬ ì±…ì„ ë²”ìœ„ë¥¼ ì•Œê³  ì‹¶ì–´ìš”" -> ì‚°ì—…ì¬í•´',
    '"ë…¸ì¡°ê°€ ë‹¨ì²´í–‰ë™ì„ ì˜ˆê³ í–ˆì–´ìš”. ëŒ€ì‘ë²•ì´ ìˆë‚˜ìš”?" -> ë…¸ë™ì¡°í•©',
    '"ì§ì› í‰ê°€ ê¸°ì¤€ì„ ìƒˆë¡œ ë§Œë“¤ê³  ì‹¶ì–´ìš”" -> ê¸°ì—…ìë¬¸',
    '"ê·¼ë¡œì ë§Œì¡±ë„ ì¡°ì‚¬ ì„¤ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤" -> ì»¨ì„¤íŒ…',
    '"ê¸‰ì—¬ ì‹œìŠ¤í…œì„ ì™¸ë¶€ì— ë§¡ê¸°ë ¤ í•©ë‹ˆë‹¤" -> ê¸‰ì—¬ì•„ì›ƒì†Œì‹±'
]

worker_examples = [
    '"ì •ë‹¹í•œ ì´ìœ  ì—†ì´ í•´ê³  í†µë³´ë¥¼ ë°›ì•˜ì–´ìš”" -> ë¶€ë‹¹í•´ê³ ',
    '"ì¶œê·¼ íƒœë„ ë¬¸ì œë¡œ ê°‘ìê¸° ì§•ê³„ë¥¼ ë°›ì•˜ì–´ìš”" -> ë¶€ë‹¹ì§•ê³„',
    '"ê·¼ë¡œê³„ì•½ì„œë¥¼ ì•„ì§ë„ ì•ˆ ì¤¬ì–´ìš”" -> ê·¼ë¡œê³„ì•½',
    '"ì£¼ë§ì— ê³„ì† ê·¼ë¬´í•˜ê³  ìˆëŠ”ë° ìˆ˜ë‹¹ì´ ì—†ì–´ìš”" -> ê·¼ë¬´ì¡°ê±´',
    '"ìƒì‚¬ê°€ ì™¸ëª¨ì— ëŒ€í•´ ë§í•´ìš”" -> ì§ì¥ë‚´ì„±í¬ë¡±',
    '"í˜¼ì ì¼í•˜ê²Œ ë§Œë“¤ì–´ìš”" -> ì§ì¥ë‚´ê´´ë¡­í˜',
    '"ë‚˜ì´ ë•Œë¬¸ì— ìŠ¹ì§„ì—ì„œ ì œì™¸ëì–´ìš”" -> ì§ì¥ë‚´ì°¨ë³„',
    '"ì›”ê¸‰ì´ ê³„ì† ì§€ì—°ë˜ê³  ìˆì–´ìš”" -> ì„ê¸ˆ/í‡´ì§ê¸ˆ',
    '"ì¶œí‡´ê·¼ ì¤‘ ì‚¬ê³ ì¸ë° ì²˜ë¦¬ê°€ ì•ˆ ë©ë‹ˆë‹¤" -> ì‚°ì—…ì¬í•´',
    '"ë…¸ì¡°ì— ê°€ì…í–ˆë”ë‹ˆ ë¶ˆì´ìµì„ ë°›ì•˜ì–´ìš”" -> ë…¸ë™ì¡°í•©'
]

casual_examples = [
    '"ì›”ê¸‰ ì•ˆì¤Œ" -> ì„ê¸ˆ/í‡´ì§ê¸ˆ',
    '"ìƒì‚¬ ê°œì§œì¦. ìš•í•¨. ì–´ë–»ê²Œ ì‹ ê³ ?" -> ì§ì¥ë‚´ê´´ë¡­í˜',
    '"ê³„ì•½ì„œë„ ì•ˆì£¼ê³  ì¼ë§Œ ì‹œì¼œìš”" -> ê·¼ë¡œê³„ì•½',
    '"ìˆ˜ìŠµ ëë‚˜ìë§ˆì í•´ê³ ã…‹ã…‹" -> ë¶€ë‹¹í•´ê³ ',
    '"ì•¼ê·¼ìˆ˜ë‹¹ ì—†ìŒ... ì´ê²ƒë„ ê´œì°®ì€ ê±´ê°€ìš”?" -> ê·¼ë¬´ì¡°ê±´',
    '"ì„±í¬ë¡± ì‹ ê³ í–ˆë”ë‹ˆ ì¼ ë” ì‹œì¼œìš”" -> ì§ì¥ë‚´ì„±í¬ë¡±',
    '"ë‹¤ì³ë„ ì‚°ì¬ì²˜ë¦¬ ì•ˆ í•´ì¤Œ" -> ì‚°ì—…ì¬í•´',
    '"ë…¸ì¡°ê°€ì…í–ˆë”ë‹ˆ ë¶€ì„œì´ë™ã… ã… " -> ë…¸ë™ì¡°í•©',
    '"ê³„ì•½ì§ì¸ë° ê³„ì•½ì„œ ì•ˆ ì”€" -> ê·¼ë¡œê³„ì•½',
    '"ë§¤ì¼ íšŒì‹ì„œ ì„±ì  ë†ë‹´í•´ìš”;;" -> ì§ì¥ë‚´ì„±í¬ë¡±'
]

fewshot_base = business_examples + worker_examples + casual_examples

# ìƒì„± í•¨ìˆ˜
def generate_prompt(user_input: str, examples: list[str], categories: list[str]) -> str:
    return f"""ë‹¹ì‹ ì€ í•œêµ­ì˜ ë…¸ë™ë¬¸ì œë¥¼ ë¶„ë¥˜í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì•„ë˜ ë¬¸ì¥ì€ ì‹¤ì œ ê·¼ë¡œì/ì‚¬ì—…ì£¼ê°€ ì§ˆë¬¸í•œ ë‚´ìš©ì´ë©°,
ì´ ë¬¸ì¥ì„ ê°€ì¥ ì˜ ì„¤ëª…í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ì„ íƒí•˜ì„¸ìš”:

- {chr(10).join(f"- {cat}" for cat in categories)}

ê·œì¹™:
- ë°˜ë“œì‹œ ìœ„ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
- ë‹¤ë¥¸ ë§ì€ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”.
- ë¶„ë¥˜ê°€ ì–´ë ¤ì›Œë„ ê°€ì¥ ìœ ì‚¬í•œ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.

ì˜ˆì‹œ:
{chr(10).join(examples)}

ì‚¬ìš©ì ë¬¸ì¥:
"{user_input}"

ğŸ‘‰ ì¹´í…Œê³ ë¦¬:"""

# ì¶œë ¥ ì •ì œ ë¡œì§
def clean_category_output(result: str) -> str:
    for cat in categories:
        if cat in result:
            return cat
    return "ë¶„ë¥˜ ì‹¤íŒ¨"

# ì˜¤ë¶„ë¥˜ ë¡œê·¸ ì €ì¥
def log_failed_classification(user_input: str, result: str):
    now = datetime.now().strftime("%Y%m%d_%H%M%S")
    log_dir = "classified_logs"
    os.makedirs(log_dir, exist_ok=True)
    with open(os.path.join(log_dir, f"fail_{now}.txt"), "w", encoding="utf-8") as f:
        f.write(f"ë¬¸ì¥: {user_input}\n")
        f.write(f"ì˜ˆì¸¡ ê²°ê³¼: {result}\n")

# ë¶„ë¥˜ í•¨ìˆ˜
def classify_text_with_openai(user_input: str) -> str:
    start = time.time()

    # âœ… ì˜ˆì‹œ 6ê°œë§Œ ì‚¬ìš© (ì¹´í…Œê³ ë¦¬ ë‹¤ì–‘ì„± í™•ë³´)
    examples = (
        random.sample(business_examples, 2) +
        random.sample(worker_examples, 2) +
        random.sample(casual_examples, 2)
    )

    prompt = generate_prompt(user_input, examples, categories)

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3,
            max_tokens=50,
        )
        raw_result = response.choices[0].message.content.strip()
        print(f"ğŸ” Raw Output: {raw_result}")
        print(f"â±ï¸ GPT ì‘ë‹µ ì‹œê°„: {time.time() - start:.2f}ì´ˆ")

        cleaned = clean_category_output(raw_result)

        # Feedback Loopìš© ì˜¤ë¶„ë¥˜ ë¡œê·¸ ì €ì¥
        if cleaned == "ë¶„ë¥˜ ì‹¤íŒ¨":
            log_failed_classification(user_input, raw_result)

        return cleaned
    except Exception as e:
        print("âŒ OpenAI API ì˜¤ë¥˜:", e)
        return "ë¶„ë¥˜ ì‹¤íŒ¨"

# FastAPI ì—”ë“œí¬ì¸íŠ¸
@router.post("/classify")
async def classify_endpoint(user_input: UserInput):
    result = classify_text_with_openai(user_input.text)
    return {"category": result}