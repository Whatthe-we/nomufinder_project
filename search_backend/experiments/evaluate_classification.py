import json
import sys
import csv
import os
from openai import OpenAI
from dotenv import load_dotenv
from sklearn.metrics import classification_report, accuracy_score

# classifier.py ìƒëŒ€ê²½ë¡œ import í—ˆìš©
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))
from classifier import (
    categories,
    clean_category_output,
    classify_text_with_openai
)

# === ëª¨ë¸ ì„¸íŒ… ===
load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
classify_text_with_openai.__globals__["client"] = client

# === í‰ê°€ ë°ì´í„° ===
def generate_eval_dataset(path="search_backend/experiments/evaluation_dataset.json"):
    dataset = [
        # ë¶€ë‹¹í•´ê³ &ë¶€ë‹¹ì§•ê³„ - ê·¼ë¡œì
        {"text": "ìˆ˜ìŠµ ëë‚˜ìë§ˆì ë‚˜ê°€ë¼ê³  í†µë³´ ë°›ì•˜ì–´ìš”", "label": "ë¶€ë‹¹í•´ê³ "},
        {"text": "ì´ìœ ë¥¼ ë“£ì§€ë„ ëª»í–ˆëŠ”ë° ì •ì§ ë‹¹í–ˆì–´ìš”", "label": "ë¶€ë‹¹ì§•ê³„"},
        {"text": "ì •ë‹¹í•œ ì‚¬ìœ ê°€ ì—†ëŠ”ë° ê³„ì•½ ì¢…ë£Œ í•˜ê² ëŒ€ìš”", "label": "ë¶€ë‹¹í•´ê³ "},
        {"text": "ì œ ì˜ëª»ì„ ì†Œëª…í•  ê¸°íšŒ ì—†ì´ ê°ë´‰ ì¡°ì¹˜ ë°›ì•˜ìŠµë‹ˆë‹¤", "label": "ë¶€ë‹¹ì§•ê³„"},
        {"text": "íšŒì‚¬ì—ì„œ ê²½ê³ ë¥¼ ê³„ì† ì¤˜ìš”", "label": "ë¶€ë‹¹ì§•ê³„"},
        # ë¶€ë‹¹í•´ê³ &ë¶€ë‹¹ì§•ê³„ - ì‚¬ì—…ì£¼
        {"text": "ìˆ˜ìŠµ ê¸°ê°„ ì¤‘ ì‹¤ë ¥ì´ ë¶€ì¡±í•œ ì‚¬ì›ì€ ë‚´ë³´ë‚¼ ìˆ˜ ìˆë‚˜ìš”?", "label": "ë¶€ë‹¹í•´ê³ "},
        {"text": "ì§ì›ì˜ ë¶ˆì„±ì‹¤í•œ ê·¼íƒœë¡œ ì¸í•œ ì§•ê³„ ì ˆì°¨ê°€ ê¶ê¸ˆí•©ë‹ˆë‹¤", "label": "ë¶€ë‹¹ì§•ê³„"},
        {"text": "ê³„ì•½ ë§Œë£Œ í›„ ì¬ê³„ì•½ ê±°ì ˆì€ ë¶€ë‹¹í•´ê³ ì¸ê°€ìš”?", "label": "ë¶€ë‹¹í•´ê³ "},
        {"text": "ê²½ê³  ì¡°ì¹˜ë¥¼ í•  ë•Œ ì£¼ì˜í•  ì ì´ ìˆë‚˜ìš”?", "label": "ë¶€ë‹¹ì§•ê³„"},
        {"text": "ì •ì§ ì²˜ë¶„ ì‹œ í•„ìš”í•œ ì‚¬ì „ ì ˆì°¨ëŠ” ë¬´ì—‡ì¸ê°€ìš”?", "label": "ë¶€ë‹¹ì§•ê³„"},

        # ê·¼ë¡œê³„ì•½&ê·¼ë¬´ì¡°ê±´ - ê·¼ë¡œì
        {"text": "ê·¼ë¡œê³„ì•½ì„œë¥¼ ì‘ì„±í•˜ì§€ ì•Šì•˜ì–´ìš”", "label": "ê·¼ë¡œê³„ì•½"},
        {"text": "ì£¼ 60ì‹œê°„ ë„˜ê²Œ ì¼í•˜ê³  ìˆì–´ìš”", "label": "ê·¼ë¬´ì¡°ê±´"},
        {"text": "ì—°ì°¨ë¥¼ ì“¸ ìˆ˜ ì—†ê²Œ ë§‰ì•„ìš”", "label": "ê·¼ë¬´ì¡°ê±´"},
        {"text": "ê·¼ë¡œê³„ì•½ ë‚´ìš©ê³¼ ì‹¤ì œ ê·¼ë¡œì¡°ê±´ì´ ë‹¬ë¼ìš”", "label": "ê·¼ë¡œê³„ì•½"},
        {"text": "ìˆ˜ìŠµ ê¸°ê°„ì´ë¼ê³  ê¸‰ì—¬ë¥¼ ì ê²Œ ì£¼ë„¤ìš”", "label": "ê·¼ë¡œê³„ì•½"},
        # ê·¼ë¡œê³„ì•½&ê·¼ë¬´ì¡°ê±´ - ì‚¬ì—…ì£¼
        {"text": "ê·¼ë¡œê³„ì•½ì„œëŠ” ì–¸ì œê¹Œì§€ ì‘ì„±í•´ì•¼ í•˜ë‚˜ìš”?", "label": "ê·¼ë¡œê³„ì•½"},
        {"text": "ì—°ì¥ê·¼ë¡œ ì‹œ ìˆ˜ë‹¹ ì§€ê¸‰ ê¸°ì¤€ì€ ë­”ê°€ìš”?", "label": "ê·¼ë¬´ì¡°ê±´"},
        {"text": "ìˆ˜ìŠµ ê¸°ê°„ ê¸‰ì—¬ë¥¼ ì¡°ì •í•  ìˆ˜ ìˆë‚˜ìš”?", "label": "ê·¼ë¡œê³„ì•½"},
        {"text": "ì—°ì°¨ ì‚¬ìš©ì„ íšŒì‚¬ê°€ ì§€ì •í•  ìˆ˜ ìˆë‚˜ìš”?", "label": "ê·¼ë¬´ì¡°ê±´"},
        {"text": "ê·¼ë¡œì‹œê°„ ë‹¨ì¶• ìš”ì²­ì„ ê±°ë¶€í•´ë„ ë˜ë‚˜ìš”?", "label": "ê·¼ë¬´ì¡°ê±´"},

        # ì§ì¥ë‚´ì„±í¬ë¡±&ê´´ë¡­í˜ - ê·¼ë¡œì
        {"text": "ìƒì‚¬ê°€ ì™¸ëª¨ë¥¼ ì§€ì í–ˆì–´ìš”", "label": "ì§ì¥ë‚´ì„±í¬ë¡±"},
        {"text": "ì„±í¬ë¡± ì‹ ê³  ì´í›„ ë³´ë³µì„ ë‹¹í–ˆì–´ìš”", "label": "ì§ì¥ë‚´ì„±í¬ë¡±"},
        {"text": "ê´´ë¡­í˜ìœ¼ë¡œ ì¸í•´ í‡´ì‚¬í•˜ê³  ì‹¶ì€ë° ì‹¤ì—…ê¸‰ì—¬ ë°›ì„ ìˆ˜ ìˆë‚˜ìš”?", "label": "ì§ì¥ë‚´ê´´ë¡­í˜"},
        {"text": "ìƒì‚¬ê°€ ìš•ì„¤ì„ í•©ë‹ˆë‹¤", "label": "ì§ì¥ë‚´ê´´ë¡­í˜"},
        {"text": "ì§‘ë‹¨ ë”°ëŒë¦¼ì„ ë‹¹í•˜ê³  ìˆì–´ìš”", "label": "ì§ì¥ë‚´ê´´ë¡­í˜"},
        # ì§ì¥ë‚´ì„±í¬ë¡±&ê´´ë¡­í˜ - ì‚¬ì—…ì£¼
        {"text": "ì„±í¬ë¡± ì˜ˆë°©êµìœ¡ì„ ê¼­ í•´ì•¼ í•˜ë‚˜ìš”?", "label": "ì§ì¥ë‚´ì„±í¬ë¡±"},
        {"text": "ì§ì¥ ë‚´ ê´´ë¡­í˜ ì‹ ê³  ì ‘ìˆ˜ ì‹œ ì¡°ì¹˜ ë°©ë²•ì€?", "label": "ì§ì¥ë‚´ê´´ë¡­í˜"},
        {"text": "ì„±í¬ë¡± ì‹ ê³ ê°€ ê±°ì§“ì¼ ê²½ìš° ëŒ€ì‘ì€?", "label": "ì§ì¥ë‚´ì„±í¬ë¡±"},
        {"text": "ì§ì¥ ë‚´ ê´´ë¡­í˜ ê°€í•´ì ì§•ê³„ ì ˆì°¨ëŠ”?", "label": "ì§ì¥ë‚´ê´´ë¡­í˜"},
        {"text": "ì§ì¥ ë‚´ ë”°ëŒë¦¼ ì¡°ì‚¬ ë°©ë²•ì´ ê¶ê¸ˆí•©ë‹ˆë‹¤", "label": "ì§ì¥ë‚´ê´´ë¡­í˜"},

        # ì§ì¥ë‚´ì°¨ë³„ - ê·¼ë¡œì
        {"text": "ì¶œì‚°íœ´ê°€ ë‹¤ë…€ì™”ë”ë‹ˆ ë¶€ì„œê°€ ë°”ë€Œì—ˆì–´ìš”", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        {"text": "ë¹„ì •ê·œì§ì´ë¼ ì—°ì°¨ë¥¼ ëª» ì¨ìš”", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        {"text": "ìœ¡ì•„íœ´ì§ ë³µê·€ í›„ ë¶ˆì´ìµì„ ë‹¹í–ˆì–´ìš”", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        {"text": "ë‚˜ì´ ë•Œë¬¸ì— ìŠ¹ì§„ì´ ì•ˆ ëœ ê²ƒ ê°™ì•„ìš”", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        {"text": "ì¥ì• ì¸ ì°¨ë³„ì„ ê²½í—˜í–ˆì–´ìš”", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        # ì§ì¥ë‚´ì°¨ë³„ - ì‚¬ì—…ì£¼
        {"text": "ì¶œì‚°íœ´ê°€ ë³µê·€ì ì¸ì‚¬ì´ë™ ê°€ëŠ¥í•œê°€ìš”?", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        {"text": "ë¹„ì •ê·œì§ ì—°ì°¨ ë¶€ì—¬ ê¸°ì¤€ì´ ê¶ê¸ˆí•©ë‹ˆë‹¤", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        {"text": "ìœ¡ì•„íœ´ì§ í›„ ë‹¤ë¥¸ ë¶€ì„œ ë°°ì¹˜í•´ë„ ë˜ë‚˜ìš”?", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        {"text": "ì •ë…„í‡´ì§ì ì¬ê³ ìš© ì˜ë¬´ê°€ ìˆë‚˜ìš”?", "label": "ì§ì¥ë‚´ì°¨ë³„"},
        {"text": "ì¥ì• ì¸ ì˜ë¬´ê³ ìš© ë¹„ìœ¨ ë¯¸ë‹¬ ì‹œ ë¶ˆì´ìµì€?", "label": "ì§ì¥ë‚´ì°¨ë³„"},

        # ì„ê¸ˆ/í‡´ì§ê¸ˆ - ê·¼ë¡œì
        {"text": "í‡´ì§ê¸ˆ ì •ì‚°ì´ ëŠ¦ì–´ì§€ê³  ìˆì–´ìš”", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        {"text": "ì›”ê¸‰ì´ ì •í•´ì§„ ë‚ ì§œì— ì•ˆ ë“¤ì–´ì™€ìš”", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        {"text": "ìˆ˜ìŠµ ê¸°ê°„ ë™ì•ˆ ìµœì €ì„ê¸ˆë„ ëª» ë°›ì•˜ì–´ìš”", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        {"text": "í‡´ì‚¬ í›„ ì„ê¸ˆì´ ì²´ë¶ˆëì–´ìš”", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        {"text": "í‡´ì§ê¸ˆì´ ì ê²Œ ë‚˜ì™”ì–´ìš”", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        # ì„ê¸ˆ/í‡´ì§ê¸ˆ - ì‚¬ì—…ì£¼
        {"text": "í‡´ì§ê¸ˆ ì§€ê¸‰ ì‹œê¸°ì™€ ë°©ë²•ì´ ê¶ê¸ˆí•©ë‹ˆë‹¤", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        {"text": "ì„ê¸ˆ ì²´ë¶ˆ ì‹œ ë²•ì  ì±…ì„ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        {"text": "í‡´ì§ê¸ˆ ê³„ì‚° ê¸°ì¤€ì„ ì•Œê³  ì‹¶ì–´ìš”", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        {"text": "ìˆ˜ìŠµ í•´ê³  ì‹œ ì„ê¸ˆ ì§€ê¸‰ ì˜ë¬´ê°€ ìˆë‚˜ìš”?", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},
        {"text": "í‡´ì§ê¸ˆ ì¤‘ê°„ì •ì‚° ê°€ëŠ¥í•œê°€ìš”?", "label": "ì„ê¸ˆ/í‡´ì§ê¸ˆ"},

        # ì‚°ì—…ì¬í•´ - ê·¼ë¡œì
        {"text": "ì¶œê·¼ê¸¸ êµí†µì‚¬ê³  ì‚°ì¬ ì²˜ë¦¬ ê°€ëŠ¥í• ê¹Œìš”?", "label": "ì‚°ì—…ì¬í•´"},
        {"text": "ì—…ë¬´ ì¤‘ í—ˆë¦¬ë¥¼ ë‹¤ì³¤ëŠ”ë° ì‚°ì¬ ì‹ ì²­ ê°€ëŠ¥í•œê°€ìš”?", "label": "ì‚°ì—…ì¬í•´"},
        {"text": "ì‚°ì¬ ì‹ ì²­í–ˆë”ë‹ˆ íšŒì‚¬ì—ì„œ ì‹«ì–´í•´ìš”", "label": "ì‚°ì—…ì¬í•´"},
        {"text": "ì‘ì—… ì¤‘ ë‹¤ì³¤ëŠ”ë° ë³‘ì›ë¹„ê°€ ê±±ì •ë¼ìš”", "label": "ì‚°ì—…ì¬í•´"},
        {"text": "ì•¼ê·¼í•˜ë‹¤ ì‚¬ê³ ë¥¼ ë‹¹í–ˆì–´ìš”", "label": "ì‚°ì—…ì¬í•´"},
        # ì‚°ì—…ì¬í•´ - ì‚¬ì—…ì£¼
        {"text": "ì‚°ì¬ ì‹ ì²­ì„ íšŒì‚¬ê°€ ê±°ë¶€í•  ìˆ˜ ìˆë‚˜ìš”?", "label": "ì‚°ì—…ì¬í•´"},
        {"text": "ì—…ë¬´ìƒ ì¬í•´ ì¸ì • ê¸°ì¤€ì´ ê¶ê¸ˆí•©ë‹ˆë‹¤", "label": "ì‚°ì—…ì¬í•´"},
        {"text": "ì‚°ì¬ ì²˜ë¦¬ ì‹œ íšŒì‚¬ ì±…ì„ ë²”ìœ„ëŠ”?", "label": "ì‚°ì—…ì¬í•´"},
        {"text": "ì¶œí‡´ê·¼ ì‚¬ê³ ë„ ì‚°ì¬ë¡œ ì¸ì •ë˜ë‚˜ìš”?", "label": "ì‚°ì—…ì¬í•´"},
        {"text": "ì‚°ì¬ ì˜ˆë°© ì¡°ì¹˜ë¥¼ ëª» í•˜ë©´ ì–´ë–¤ ì²˜ë²Œì„ ë°›ë‚˜ìš”?", "label": "ì‚°ì—…ì¬í•´"},

        # ë…¸ë™ì¡°í•© - ê·¼ë¡œì
        {"text": "ë…¸ì¡° ê°€ì…í•œë‹¤ê³  í–ˆë”ë‹ˆ ê´´ë¡­í˜ì„ ë‹¹í•´ìš”", "label": "ë…¸ë™ì¡°í•©"},
        {"text": "ë…¸ì¡° í™œë™ ë•Œë¬¸ì— ì¸ì‚¬ ë¶ˆì´ìµì„ ë°›ì•˜ì–´ìš”", "label": "ë…¸ë™ì¡°í•©"},
        {"text": "ë…¸ì¡° ê°€ì…ë¹„ëŠ” ë°˜ë“œì‹œ ë‚´ì•¼ í•˜ë‚˜ìš”?", "label": "ë…¸ë™ì¡°í•©"},
        {"text": "ë…¸ì¡° ê°€ì…ì„ ì´ìœ ë¡œ ë¶€ë‹¹ì „ì¶œ ë‹¹í–ˆì–´ìš”", "label": "ë…¸ë™ì¡°í•©"},
        {"text": "íŒŒì—…ì— ì°¸ê°€í•˜ë©´ ì§•ê³„ë‹¹í•  ìˆ˜ ìˆë‚˜ìš”?", "label": "ë…¸ë™ì¡°í•©"},
        # ë…¸ë™ì¡°í•© - ì‚¬ì—…ì£¼
        {"text": "êµì„­ëŒ€í‘œë…¸ì¡°ì™€ì˜ êµì„­ ë°©ë²•ì´ ê¶ê¸ˆí•©ë‹ˆë‹¤", "label": "ë…¸ë™ì¡°í•©"},
        {"text": "ë…¸ì¡° í™œë™ì„ ì´ìœ ë¡œ í•´ê³ í•˜ë©´ ë¶ˆë²•ì¸ê°€ìš”?", "label": "ë…¸ë™ì¡°í•©"},
        {"text": "ë³µìˆ˜ë…¸ì¡° ëŒ€ì‘ ë°©ë²•ì´ í•„ìš”í•©ë‹ˆë‹¤", "label": "ë…¸ë™ì¡°í•©"},
        {"text": "ë…¸ì¡° íŒŒì—… ì‹œ ì„ê¸ˆ ì§€ê¸‰ ì˜ë¬´ê°€ ìˆë‚˜ìš”?", "label": "ë…¸ë™ì¡°í•©"},
        {"text": "ë…¸ë™ì¡°í•©ì— í˜‘ë°•ì„± ìš”êµ¬ë¥¼ ë°›ì„ ë•Œ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?", "label": "ë…¸ë™ì¡°í•©"},

        # ê¸°ì—…ìë¬¸ - ì‚¬ì—…ì£¼
        {"text": "ì·¨ì—…ê·œì¹™ ê°œì •í•  ë•Œ í•„ìš”í•œ ì ˆì°¨ëŠ”?", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ê·¼ë¡œì‹œê°„ ìœ ì—°í•˜ê²Œ ì¡°ì •í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ì¸ì‚¬ê·œì • ìƒˆë¡œ ì •ë¹„í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ë…¸ë¬´ ë¦¬ìŠ¤í¬ ì˜ˆë°©ì„ ìœ„í•œ ì ê²€ ë°©ë²•ì€?", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ì§ì¥ ë‚´ ê´´ë¡­í˜ ì˜ˆë°© ë§¤ë‰´ì–¼ ì‘ì„± ë°©ë²•ì€?", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ê·¼ë¡œê°ë… ëŒ€ë¹„ ì¤€ë¹„í•  ìˆ˜ ìˆëŠ” ê²Œ ë­”ê°€ìš”?", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ì •ë¦¬í•´ê³  ì§„í–‰ ì‹œ í•„ìˆ˜ ì ˆì°¨ê°€ ìˆë‚˜ìš”?", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ì§•ê³„ ê·œì • ì—…ë°ì´íŠ¸ ë°©ë²•ì´ ê¶ê¸ˆí•©ë‹ˆë‹¤", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ê·¼ë¡œìëŒ€í‘œ ì„ ì¶œ ì ˆì°¨ê°€ í•„ìš”í• ê¹Œìš”?", "label": "ê¸°ì—…ìë¬¸"},
        {"text": "ì‹ ê·œ ì…ì‚¬ì êµìœ¡ ìë£Œë¥¼ ì¤€ë¹„í•˜ë ¤ë©´?", "label": "ê¸°ì—…ìë¬¸"},

        # ì»¨ì„¤íŒ… - ì‚¬ì—…ì£¼
        {"text": "ì¸ì‚¬í‰ê°€ ì œë„ ì»¨ì„¤íŒ…ì„ ë°›ê³  ì‹¶ì–´ìš”", "label": "ì»¨ì„¤íŒ…"},
        {"text": "ì„±ê³¼ê¸‰ ì œë„ë¥¼ ë„ì…í•˜ê³  ì‹¶ì€ë° ë°©ë²•ì€?", "label": "ì»¨ì„¤íŒ…"},
        {"text": "ì¡°ì§ë¬¸í™” ì§„ë‹¨ ì»¨ì„¤íŒ… ë°›ê³  ì‹¶ìŠµë‹ˆë‹¤", "label": "ì»¨ì„¤íŒ…"},
        {"text": "ESG ê²½ì˜ ì»¨ì„¤íŒ… ëŒ€ìƒì´ ê¶ê¸ˆí•©ë‹ˆë‹¤", "label": "ì»¨ì„¤íŒ…"},
        {"text": "ì„ê¸ˆí”¼í¬ì œ ë„ì… ì»¨ì„¤íŒ… ë°›ê³  ì‹¶ì–´ìš”", "label": "ì»¨ì„¤íŒ…"},
        {"text": "ì§ë¬´ë¶„ì„ ì»¨ì„¤íŒ… ì ˆì°¨ê°€ ê¶ê¸ˆí•´ìš”", "label": "ì»¨ì„¤íŒ…"},
        {"text": "ì±„ìš© ì»¨ì„¤íŒ…ì„ í†µí•´ ê³µì •ì„± í™•ë³´ê°€ ê°€ëŠ¥í•œê°€ìš”?", "label": "ì»¨ì„¤íŒ…"},
        {"text": "4ëŒ€ë³´í—˜ ì •ì‚° ì»¨ì„¤íŒ…ë„ ê°€ëŠ¥í•œê°€ìš”?", "label": "ì»¨ì„¤íŒ…"},
        {"text": "ì„ê¸ˆì²´ê³„ ê°œí¸ ì»¨ì„¤íŒ… ë°›ê³  ì‹¶ì–´ìš”", "label": "ì»¨ì„¤íŒ…"},
        {"text": "ë…¸ì‚¬ê´€ê³„ ê°œì„  ì»¨ì„¤íŒ…ì„ ë°›ê³  ì‹¶ì–´ìš”", "label": "ì»¨ì„¤íŒ…"},

        # ê¸‰ì—¬ì•„ì›ƒì†Œì‹± - ì‚¬ì—…ì£¼
        {"text": "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹±ì„ ë§¡ê¸°ë©´ ì–´ë–¤ ì´ì ì´ ìˆë‚˜ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "ê¸‰ì—¬ ëŒ€í–‰ ì„œë¹„ìŠ¤ ì´ìš© ë¹„ìš©ì€ ì–¼ë§ˆë‚˜ í•˜ë‚˜ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "í‡´ì§ê¸ˆ ì •ì‚°ê¹Œì§€ ë§¡ê¸¸ ìˆ˜ ìˆë‚˜ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "4ëŒ€ë³´í—˜ ì‹ ê³ ë„ ê¸‰ì—¬ ëŒ€í–‰ì—ì„œ í•´ì£¼ë‚˜ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡ì€ ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ë‚˜ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "ê¸‰ì—¬ ì´ì²´ëŠ” ìë™ìœ¼ë¡œ ì´ë¤„ì§€ë‚˜ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "ë¹„ì •ê·œì§ ê¸‰ì—¬ ê³„ì‚°ë„ ëŒ€í–‰ ê°€ëŠ¥í•œê°€ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "ê¸‰ì—¬ìë£Œ ì œê³µ ë°©ì‹ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "ê¸‰ì—¬ ëŒ€í–‰ ì—…ì²´ ì„ ì • ì‹œ ì£¼ì˜í•  ì ì€?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"},
        {"text": "í‡´ì§ ì—°ê¸ˆ ì²˜ë¦¬ë„ ëŒ€í–‰ í•´ì£¼ë‚˜ìš”?", "label": "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±"}
    ]
    with open(path, "w", encoding="utf-8") as f:
        json.dump(dataset, f, ensure_ascii=False, indent=2)
    print(f"âœ… í‰ê°€ì…‹ ì €ì¥ë¨: {path}")
    return dataset

# === Zero-shot ë¶„ë¥˜ í•¨ìˆ˜ ===
def classify_text_zeroshot(user_input: str) -> str:
    prompt = f"""
ë‹¹ì‹ ì€ ì•„ë˜ ë¬¸ì¥ì„ ë¶„ë¥˜í•˜ëŠ” AIì…ë‹ˆë‹¤.
ë¬¸ì¥ì„ ì•„ë˜ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”:

- {', '.join(categories)}

ë¬¸ì¥: {user_input}
ì¹´í…Œê³ ë¦¬:"""
    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3,
            max_tokens=50,
        )
        result = response.choices[0].message.content.strip()
        return clean_category_output(result)
    except Exception as e:
        print("âŒ Zero-shot ì˜¤ë¥˜:", e)
        return "ë¶„ë¥˜ ì‹¤íŒ¨"

# === ì˜¤ë‹µ ë¡œê·¸ ì €ì¥ ===
def save_misclassified_log(name, y_true, y_pred, dataset, path_prefix="search_backend/experiments"):
    misclassified = []
    for i, (true, pred) in enumerate(zip(y_true, y_pred)):
        if true != pred:
            misclassified.append({
                "model": name,
                "text": dataset[i]["text"],
                "true_label": true,
                "predicted_label": pred
            })

    if not misclassified:
        print(f"âœ… [{name}] ëª¨ë“  ì˜ˆì¸¡ì´ ì •ë‹µì…ë‹ˆë‹¤!")
        return

    full_path = os.path.join(path_prefix, f"misclassified_{name.lower().replace('-', '_')}.json")
    with open(full_path, "w", encoding="utf-8") as f:
        json.dump(misclassified, f, ensure_ascii=False, indent=2)
    print(f"â— ì˜¤ë‹µ ë¡œê·¸ ì €ì¥ë¨: {full_path}")

# === í‰ê°€ í•¨ìˆ˜ ===
def evaluate_model(name, classify_fn, dataset):
    y_true, y_pred = [], []
    for item in dataset:
        text, label = item["text"], item["label"]
        pred = classify_fn(text)
        y_true.append(label)
        y_pred.append(pred)
        print(f"[{name}] {text}\nğŸ‘‰ ì˜ˆì¸¡: {pred}, âœ… ì •ë‹µ: {label}\n")

    acc = accuracy_score(y_true, y_pred)
    report = classification_report(y_true, y_pred, labels=categories, zero_division=0, output_dict=True)

    # ì˜¤ë‹µ ì €ì¥
    save_misclassified_log(name, y_true, y_pred, dataset)

    # âœ… Per-class F1 ì¶”ê°€ ì¶œë ¥
    print(f"\nğŸ“Š [{name}] Per-class F1-score:")
    per_class_f1 = {}
    for category in categories:
        f1 = report[category]["f1-score"]
        per_class_f1[category] = f1
        print(f"- {category}: {f1:.3f}")

    return {
        "name": name,
        "accuracy": acc,
        "macro_f1": report["macro avg"]["f1-score"],
        "per_class_f1": per_class_f1  # âœ… ì¶”ê°€!!
    }

# === ê²°ê³¼ CSV ì €ì¥ ===
def save_results_csv(results: list[dict], path="search_backend/experiments/evaluation_result.csv"):
    with open(path, mode="w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=["name", "accuracy", "macro_f1"])
        writer.writeheader()
        for row in results:
            writer.writerow({
                "name": row["name"],
                "accuracy": row["accuracy"],
                "macro_f1": row["macro_f1"],
            })
    print(f"ğŸ“„ ì„±ëŠ¥ ê²°ê³¼ ì €ì¥ë¨: {path}")

# === Per-class F1 ì €ì¥ ===
def save_per_class_f1_csv(results: list[dict], path="search_backend/experiments/per_class_f1_result.csv"):
    with open(path, mode="w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["model", "category", "f1_score"])
        for row in results:
            name = row["name"]
            per_class_f1 = row["per_class_f1"]
            for category, f1 in per_class_f1.items():
                writer.writerow([name, category, f1])
    print(f"ğŸ“„ Per-class F1 ê²°ê³¼ ì €ì¥ë¨: {path}")

# === ë©”ì¸ ì‹¤í–‰ ===
if __name__ == "__main__":
    print("ğŸš€ í‰ê°€ ì‹œì‘")
    dataset = generate_eval_dataset()

    # Few-shot
    few_result = evaluate_model("Few-shot", classify_text_with_openai, dataset)

    # Zero-shot
    zero_result = evaluate_model("Zero-shot", classify_text_zeroshot, dataset)

    # ì €ì¥
    save_results_csv([few_result, zero_result])
    save_per_class_f1_csv([few_result, zero_result])  # âœ… ì¶”ê°€