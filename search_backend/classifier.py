import os
import random
from fastapi import APIRouter
from pydantic import BaseModel
from typing import Optional
from openai import OpenAI
from datetime import datetime
import time

# ë¼ìš°í„° ì´ˆê¸°í™”
router = APIRouter()

# ì „ì—­ í‚¤ ì„¤ì •
client: OpenAI = None

def set_openai_api_key(api_key: str):
    global client
    client = OpenAI(api_key=api_key)

# ì‚¬ìš©ì ì…ë ¥ ëª¨ë¸
class UserInput(BaseModel):
    text: str

# ìë™ì™„ì„± í‚¤ì›Œë“œ ë§µ
autocomplete_map = {
    "ë¶€ë‹¹í•´ê³ ": ["í•´ê³ ", "í•´ê³ ì˜ˆê³ ìˆ˜ë‹¹", "ìˆ˜ìŠµê¸°ê°„ í•´ê³ ", "ê¶Œê³ ì‚¬ì§", "ë¶€ë‹¹í•´ê³  ê¸°ì¤€", "í•´ê³  ì‹¤ì—…ê¸‰ì—¬", "í•´ê³ ì‚¬ìœ ", "ë¶€ë‹¹í•´ê³  ì‚¬ë¡€", "ì •ê·œì§ í•´ê³ ", "ë¶€ë‹¹í•´ê³  êµ¬ì œì‹ ì²­"],
    "ë¶€ë‹¹ì§•ê³„": ["ì§•ê³„", "ì •ì§", "ê°ë´‰", "í•´ê³ ", "ê²½ê³ ", "ì§•ê³„ìœ„ì›íšŒ", "ì§•ê³„ì‚¬ìœ  ë¯¸í†µë³´", "ì§•ê³„ì ˆì°¨ ìœ„ë°˜", "ì´ì¤‘ì§•ê³„", "ëŒ€ê¸°ë°œë ¹"],
    "ê·¼ë¡œê³„ì•½": ["ê·¼ë¡œê³„ì•½ì„œ ë¯¸ì‘ì„±", "ê·¼ë¡œê³„ì•½ì„œ ì‘ì„±ì‹œê¸°", "ê·¼ë¡œê³„ì•½ì„œ ìœ„ë°˜", "ì•„ë¥´ë°”ì´íŠ¸ ê·¼ë¡œê³„ì•½ì„œ ì–‘ì‹", "ê·¼ë¡œê³„ì•½ ë§Œë£Œ í†µë³´ì„œ", "ê·¼ë¡œê³„ì•½ í•´ì§€", "ë¬´ê¸°ê³„ì•½ì§ ì „í™˜", "ë¶ˆë¦¬í•œ ê³„ì•½ ì¡°ê±´", "ìˆ˜ìŠµ ê³„ì•½ì„œ", "ê³„ì•½ ì—°ì¥ ê±°ì ˆ"],
    "ê·¼ë¬´ì¡°ê±´": ["ê·¼ë¡œì¡°ê±´", "ê·¼ë¬´ì¡°ê±´ ë³€ê²½", "ê·¼ë¬´ì¡°ê±´ ì‹¤ì—…ê¸‰ì—¬", "ê·¼ë¬´ì¡°ê±´ ë³€ê²½ í‡´ì‚¬", "ê·¼ë¬´ì¡°ê±´ ë³€ê²½ í‡´ì§ê¸ˆ", "ê·¼ë¬´ì¡°ê±´ ë‹¤ë¦„", "ì£¼íœ´ìˆ˜ë‹¹ ë¯¸ì§€ê¸‰", "ìœ ê¸‰íœ´ê°€", "êµëŒ€ê·¼ë¬´", "ì´ˆê³¼ê·¼ë¬´ ê°•ìš”"],
    "ì§ì¥ë‚´ì„±í¬ë¡±": ["ì„±í¬ë¡±", "ì„±ì¶”í–‰", "ì„±í¬ë¡± ì˜ˆë°©êµìœ¡", "ì„±í¬ë¡± ì²˜ë²Œ", "ì„±í¬ë¡± í”¼í•´ ì…ì¦", "ì„±í¬ë¡± ì‹ ê³ ", "ì„±í¬ë¡± ì‚¬ë¡€", "ì„±í¬ë¡± í‡´ì‚¬", "ì„±í¬ë¡± ì‹¤ì—…ê¸‰ì—¬", "ì„±í¬ë¡± 2ì°¨ ê°€í•´"],
    "ì§ì¥ë‚´ê´´ë¡­í˜": ["ê´´ë¡­í˜", "ì§ì¥ ë‚´ ê´´ë¡­í˜ ì²˜ë²Œ", "ì§ì¥ ë‚´ ê´´ë¡­í˜ ì¦ê±°", "ê´´ë¡­í˜ ì‚¬ë¡€", "ì§ì¥ ë‚´ ê´´ë¡­í˜ ì‹¤ì—…ê¸‰ì—¬", "ê´´ë¡­í˜ í‡´ì‚¬", "ê´´ë¡­í˜ ì²˜ë²Œê¸°ì¤€", "ì§ì¥ ë‚´ ê´´ë¡­í˜ ë¬´ê³ ", "ì§ì¥ ë‚´ ê´´ë¡­í˜ ì‹ ê³ ", "ì§ì¥ ë‚´ ì™•ë”°"],
    "ì§ì¥ë‚´ì°¨ë³„": ["ì°¨ë³„", "ì„±ì°¨ë³„", "ë‚˜ì´ ì°¨ë³„", "ì¶œì‚°íœ´ê°€ ë¶ˆì´ìµ", "ìœ¡ì•„íœ´ì§ ë¶ˆì´ìµ", "ì§ë¬´ ì°¨ë³„", "ê¸°ê°„ì œ ì°¨ë³„", "ë¹„ì •ê·œì§ ì°¨ë³„", "ì¥ì• ì¸ ì°¨ë³„", "ì—…ë¬´ ë°°ì • ì°¨ë³„"],
    "ì„ê¸ˆ/í‡´ì§ê¸ˆ": ["ìµœì €ì„ê¸ˆ", "ì„ê¸ˆì²´ë¶ˆ ì‹ ê³ ", "ì„ê¸ˆí”¼í¬ì œ", "ì„ê¸ˆ ëœ»", "í‰ê· ì„ê¸ˆ", "ìµœì €ì„ê¸ˆ ìœ„ë°˜", "í‡´ì§ê¸ˆ ì§€ê¸‰ê¸°ì¤€", "í‡´ì§ê¸ˆ ê³„ì‚°", "í‡´ì§ê¸ˆ ì§€ê¸‰ê¸°í•œ", "í‡´ì§ê¸ˆ ì„¸ê¸ˆ", "í‡´ì§ê¸ˆ IRP", "í‡´ì§ê¸ˆ ë¯¸ì§€ê¸‰ ì‹ ê³ "],
    "ì‚°ì—…ì¬í•´": ["ì‚°ì¬", "ì‚°ì—…ì¬í•´ì¡°ì‚¬í‘œ", "ì¤‘ëŒ€ì‚°ì—…ì¬í•´", "ì‚°ì—…ì¬í•´ ë³´ìƒ", "ì‚°ì—…ì¬í•´ê¸°ë¡ ë³´ì¡´ê¸°ê°„", "ì‚°ì—…ì•ˆì „ë³´ê±´ë²•", "ì¤‘ëŒ€ì¬í•´ì²˜ë²Œë²•", "ì¶œí‡´ê·¼ ì‚¬ê³ ", "ì‚°ì—…ì•ˆì „êµìœ¡", "ì‚°ì—…ì•ˆì „ ì»¨ì„¤íŒ…"],
    "ë…¸ë™ì¡°í•©": ["ë…¸ì¡°", "ë…¸ë™ì¡°í•© ëœ»", "íŒŒì—…", "ë‹¨ì²´êµì„­", "ì„ê¸ˆ í˜‘ìƒ", "ë…¸ë™ì¡°í•© êµìœ¡", "êµì„­ëŒ€í‘œ ë…¸ì¡°", "ë…¸ì¡° í™œë™ ë¶ˆì´ìµ", "ê·¼ë¡œì‹œê°„ ë©´ì œì œë„", "ë…¸ë™ì¡°í•©ë¹„"],
    "ê¸°ì—…ìë¬¸": ["ê¸°ì—… ë…¸ë¬´ìë¬¸", "ë…¸ë¬´ë²•ì¸ ìë¬¸", "ë…¸ë¬´ì‚¬ ìë¬¸ê³„ì•½", "ë…¸ë¬´ ëŒ€í–‰", "ì¸ì‚¬ê·œì • ì •ë¹„", "ì„ê¸ˆì²´ê³„ ê°œí¸", "ì·¨ì—…ê·œì¹™ ì œê°œì •", "ê·¼ë¡œê°ë… ëŒ€ì‘", "ë…¸ì‚¬ê´€ê³„ ì „ëµ", "ë…¸ë™ë²• ê°œì • ëŒ€ì‘"],
    "ì»¨ì„¤íŒ…": ["ì¸ì‚¬ë…¸ë¬´ ì»¨ì„¤íŒ…", "ë…¸ë¬´ì‚¬ ì»¨ì„¤íŒ…", "ë…¸ë¬´ ì»¨ì„¤íŒ… ë¹„ìš©", "ê¸‰ì—¬ ì»¨ì„¤íŒ…" "IT ì»¨ì„¤íŒ…", "ì„±ê³¼ê´€ë¦¬ ì»¨ì„¤íŒ…", "ì§ë¬´ë¶„ì„ ì»¨ì„¤íŒ…", "ESG ì»¨ì„¤íŒ…", "í‰ê°€ì œë„ ì»¨ì„¤íŒ…", "ì±„ìš© ì»¨ì„¤íŒ…"],
    "ê¸‰ì—¬ì•„ì›ƒì†Œì‹±": ["ê¸‰ì—¬ í”„ë¡œê·¸ë¨", "ê¸‰ì—¬ ê´€ë¦¬", "ê¸‰ì—¬ ëŒ€í–‰", "ë…¸ë¬´ë²•ì¸ ê¸‰ì—¬ ì•„ì›ƒì†Œì‹±", "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹± í›„ê¸°", "ê¸‰ì—¬ ì•„ì›ƒì†Œì‹± ìˆ˜ìˆ˜ë£Œ", "í‡´ì§ê¸ˆ ì •ì‚°", "4ëŒ€ ë³´í—˜ ì‹ ê³  ëŒ€í–‰", "4ëŒ€ë³´í—˜ ë° ì›ì²œì§•ìˆ˜", "ê¸‰ì—¬ ëª…ì„¸ì„œ ë°œê¸‰"]
}
# ì¹´í…Œê³ ë¦¬ ëª©ë¡
categories = list(autocomplete_map.keys())

# Few-shot ì˜ˆì‹œ
business_examples = [
    '"ë¬´ë‹¨ê²°ê·¼í•œ ì§ì›ì˜ í•´ê³ ê°€ ê°€ëŠ¥í•œì§€ ê¶ê¸ˆí•´ìš”" -> ë¶€ë‹¹í•´ê³ ',
    '"ì‹ ê·œ ì‚¬ì—… ê°œì‹œë¡œ ì¸í•´ ì¸ë ¥ êµ¬ì¡°ì¡°ì •ì´ í•„ìš”í•´ìš”" -> ë¶€ë‹¹í•´ê³ ',
    '"ì§€ê°ì´ ì¦ì€ ì§ì›ì—ê²Œ ì§•ê³„ ê°€ëŠ¥í•œê°€ìš”?" -> ë¶€ë‹¹ì§•ê³„',
    '"ê¸‰ì—¬ ì´ì²´ê°€ ì§€ì—°ë˜ì—ˆëŠ”ë° ì–´ë–»ê²Œ ëŒ€ì‘í•´ì•¼ í• ê¹Œìš”?" -> ì„ê¸ˆ/í‡´ì§ê¸ˆ',
    '"ì„±í¬ë¡± ì‹ ê³ ê°€ ì ‘ìˆ˜ëì„ ë•Œ ê¸°ì—…ì˜ ì±…ì„ì€?" -> ì§ì¥ë‚´ì„±í¬ë¡±',
    '"ì§ì›ì´ ê´´ë¡­í˜ì„ ë‹¹í–ˆë‹¤ê³  ì£¼ì¥í•´ìš”" -> ì§ì¥ë‚´ê´´ë¡­í˜',
    '"ì‚°ì¬ ë°œìƒ í›„ íšŒì‚¬ ì±…ì„ ë²”ìœ„ë¥¼ ì•Œê³  ì‹¶ì–´ìš”" -> ì‚°ì—…ì¬í•´',
    '"ë…¸ì¡°ê°€ ë‹¨ì²´í–‰ë™ì„ ì˜ˆê³ í–ˆì–´ìš”. ëŒ€ì‘ë²•ì´ ìˆë‚˜ìš”?" -> ë…¸ë™ì¡°í•©',
    '"ì§ì› í‰ê°€ ê¸°ì¤€ì„ ìƒˆë¡œ ë§Œë“¤ê³  ì‹¶ì–´ìš”" -> ê¸°ì—…ìë¬¸',
    '"ê·¼ë¡œì ë§Œì¡±ë„ ì¡°ì‚¬ ì„¤ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤" -> ì»¨ì„¤íŒ…',
    '"ê¸‰ì—¬ ì‹œìŠ¤í…œì„ ì™¸ë¶€ì— ë§¡ê¸°ë ¤ í•©ë‹ˆë‹¤" -> ê¸‰ì—¬ì•„ì›ƒì†Œì‹±'
    '"ì •ë¦¬í•´ê³  ì ˆì°¨ë¥¼ ì‚¬ì „ì— ì¤€ë¹„í•˜ë ¤ í•©ë‹ˆë‹¤." -> ê¸°ì—…ìë¬¸',
    '"ê·¼ë¡œê°ë… ëŒ€ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê³  ì‹¶ìŠµë‹ˆë‹¤." -> ê¸°ì—…ìë¬¸',
    '"ìš°ë¦¬ íšŒì‚¬ ì¡°ì§ë¬¸í™”ë¥¼ ì§„ë‹¨í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤" -> ì»¨ì„¤íŒ…',
    '"ì¸ì‚¬í‰ê°€ ì œë„ ë„ì… ì»¨ì„¤íŒ…ì„ ë°›ê³  ì‹¶ì–´ìš”" -> ì»¨ì„¤íŒ…',
]

worker_examples = [
    '"ì •ë‹¹í•œ ì´ìœ  ì—†ì´ í•´ê³  í†µë³´ë¥¼ ë°›ì•˜ì–´ìš”" -> ë¶€ë‹¹í•´ê³ ',
    '"ì¶œê·¼ íƒœë„ ë¬¸ì œë¡œ ê°‘ìê¸° ì§•ê³„ë¥¼ ë°›ì•˜ì–´ìš”" -> ë¶€ë‹¹ì§•ê³„',
    '"ê·¼ë¡œê³„ì•½ì„œì— ëª…ì‹œëœ ì¡°ê±´ê³¼ ì‹¤ì œ ê·¼ë¡œì¡°ê±´ì´ ë‹¤ë¦…ë‹ˆë‹¤" -> ê·¼ë¡œê³„ì•½',
    '"ì£¼ë§ì— ê³„ì† ê·¼ë¬´í•˜ê³  ìˆëŠ”ë° ìˆ˜ë‹¹ì´ ì—†ì–´ìš”" -> ì„ê¸ˆ/í‡´ì§ê¸ˆ',
    '"ìƒì‚¬ê°€ ì™¸ëª¨ì— ëŒ€í•´ ë§í•´ìš”" -> ì§ì¥ë‚´ì„±í¬ë¡±',
    '"í˜¼ì ì¼í•˜ê²Œ ë§Œë“¤ì–´ìš”" -> ì§ì¥ë‚´ê´´ë¡­í˜',
    '"ë‚˜ì´ ë•Œë¬¸ì— ìŠ¹ì§„ì—ì„œ ì œì™¸ëì–´ìš”" -> ì§ì¥ë‚´ì°¨ë³„',
    '"ì›”ê¸‰ì´ ê³„ì† ì§€ì—°ë˜ê³  ìˆì–´ìš”" -> ì„ê¸ˆ/í‡´ì§ê¸ˆ',
    '"ì¶œí‡´ê·¼ ì¤‘ ì‚¬ê³ ì¸ë° ì²˜ë¦¬ê°€ ì•ˆ ë©ë‹ˆë‹¤" -> ì‚°ì—…ì¬í•´',
    '"ë…¸ì¡°ì— ê°€ì…í–ˆë”ë‹ˆ ë¶ˆì´ìµì„ ë°›ì•˜ì–´ìš”" -> ë…¸ë™ì¡°í•©'
    '"ì •ê·œì§ê³¼ ë¹„ì •ê·œì§ì˜ ì—°ì°¨ ì‚¬ìš©ì´ ë‹¤ë¦…ë‹ˆë‹¤" -> ì§ì¥ë‚´ì°¨ë³„',
    '"ì¶œì‚°íœ´ê°€ ë³µê·€ í›„ ë¶€ì„œ ë³€ê²½ í†µë³´ ë°›ì•˜ìŠµë‹ˆë‹¤" -> ì§ì¥ë‚´ì°¨ë³„',
    '"ìœ¡ì•„íœ´ì§ í›„ ì¸ì‚¬ìƒ ë¶ˆì´ìµì„ ë°›ì€ ê²ƒ ê°™ì•„ìš”" -> ì§ì¥ë‚´ì°¨ë³„',
    '"ì´ìœ ë„ ëª¨ë¥´ê³  ì •ì§ ì²˜ë¶„ ë°›ì•˜ì–´ìš”" -> ë¶€ë‹¹ì§•ê³„',
    '"ìˆ˜ìŠµê¸°ê°„ ì¤‘ ë³„ë‹¤ë¥¸ ë¬¸ì œ ì—†ì—ˆëŠ”ë° ë‚˜ì˜¤ì§€ë§ë˜ìš”" -> ë¶€ë‹¹í•´ê³ ',
    '"ê³„ì•½ ê¸°ê°„ ëë‚˜ìë§ˆì ì¬ê³„ì•½ ê±°ì ˆ ë‹¹í–ˆì–´ìš”" -> ë¶€ë‹¹í•´ê³ ',
]

casual_examples = [
    '"ì›”ê¸‰ ì•ˆì¤Œ" -> ì„ê¸ˆ/í‡´ì§ê¸ˆ',
    '"ìƒì‚¬ ê°œì§œì¦. ìš•í•¨. ì–´ë–»ê²Œ ì‹ ê³ ?" -> ì§ì¥ë‚´ê´´ë¡­í˜',
    '"ê³„ì•½ì„œë„ ì•ˆì£¼ê³  ì¼ë§Œ ì‹œì¼œìš”" -> ê·¼ë¡œê³„ì•½',
    '"ìˆ˜ìŠµ ëë‚˜ìë§ˆì í•´ê³ ã…‹ã…‹" -> ë¶€ë‹¹í•´ê³ ',
    '"ì£¼60ì‹œê°„ ë„˜ê²Œ ì¼í•¨.. ì´ê²ƒë„ ê´œì°®ì€ ê±´ê°€ìš”?" -> ê·¼ë¬´ì¡°ê±´',
    '"ì„±í¬ë¡± ì‹ ê³ í–ˆë”ë‹ˆ ì¼ ë” ì‹œì¼œìš”" -> ì§ì¥ë‚´ì„±í¬ë¡±',
    '"ë‹¤ì³ë„ ì‚°ì¬ì²˜ë¦¬ ì•ˆ í•´ì¤Œ" -> ì‚°ì—…ì¬í•´',
    '"ë…¸ì¡°ê°€ì…í–ˆë”ë‹ˆ ë¶€ì„œì´ë™ã… ã… " -> ë…¸ë™ì¡°í•©',
    '"ê³„ì•½ì§ì¸ë° ê³„ì•½ì„œ ì•ˆ ì”€" -> ê·¼ë¡œê³„ì•½',
    '"ë§¤ì¼ íšŒì‹ì„œ ì„±ì  ë†ë‹´í•´ìš”;;" -> ì§ì¥ë‚´ì„±í¬ë¡±'
]

fewshot_base = business_examples + worker_examples + casual_examples

# ìƒì„± í•¨ìˆ˜
def generate_prompt(user_input: str, examples: list[str], categories: list[str]) -> str:
    return f"""ë‹¹ì‹ ì€ í•œêµ­ì˜ ë…¸ë™ë¬¸ì œë¥¼ ë¶„ë¥˜í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

íŠ¹íˆ ë‹¤ìŒì„ ì£¼ì˜í•˜ì„¸ìš”:
- ì‚¬ìš©ìê°€ ìì‹ ì˜ ê¶Œë¦¬ ì¹¨í•´ë¥¼ í˜¸ì†Œí•˜ë©´ ê·¼ë¡œì ê´€ë ¨ ì¹´í…Œê³ ë¦¬(ê·¼ë¬´ì¡°ê±´ ë“±)ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.
- ì‚¬ìš©ìê°€ ê·œì • ê°œì •, ì œë„ ê°œì„ , ë¦¬ìŠ¤í¬ ì ê²€ ë“±ì„ ë¬¸ì˜í•˜ë©´ ì‚¬ì—…ì£¼ ê´€ë ¨ ì¹´í…Œê³ ë¦¬(ê¸°ì—…ìë¬¸ ë“±)ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”.

- "ì •ì§", "ê°ë´‰", "ê²½ê³ ", "ëŒ€ê¸°ë°œë ¹" ë“±ì€ ë¶€ë‹¹ì§•ê³„ì— í•´ë‹¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
- "í•´ê³  í†µë³´", "ê³„ì•½ë§Œë£Œ í†µë³´", "ìˆ˜ìŠµ í•´ê³ ", "ê¶Œê³ ì‚¬ì§", "ìë¥´ë‹¤", "ë‚´ë³´ë‚´ë‹¤" ë“±ì€ ë¶€ë‹¹í•´ê³ ì— í•´ë‹¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
- "ëª¨ìš•", "ì—…ë¬´ ë°°ì œ", "ì‚¬ì  ì—…ë¬´ ì§€ì‹œ","ìš•ì„¤", "í­ë ¥", "ë”°ëŒë¦¼"ì€ ì§ì¥ë‚´ê´´ë¡­í˜ì— í•´ë‹¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
- "ì„±ì  ë†ë‹´", "ì‹ ì²´ ì ‘ì´‰"ì€ ì§ì¥ë‚´ì„±í¬ë¡±ì— í•´ë‹¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
- "ì—°ë ¹Â·ë‚˜ì´ ì œí•œ", ìœ¡ì•„íœ´ì§ ë¶ˆì´ìµ", "ì¶œì‚°íœ´ê°€ ë¶ˆì´ìµ", "ì¥ì• ì¸ ì°¨ë³„", "ë¹„ì •ê·œì§ ì°¨ë³„", "ì •ë…„ ì°¨ë³„", "ë™ì¼ë…¸ë™ ë™ì¼ì„ê¸ˆ"ì€ ì§ì¥ë‚´ì°¨ë³„ì— í•´ë‹¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
- "ë…¸ì¡°", "íŒŒì—…", "ë‹¨ì²´êµì„­"ì€ ë…¸ë™ì¡°í•©ì— í•´ë‹¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
- "ì»¨ì„¤íŒ…", "êµ¬ì¡° ê°œí¸", "ì²´ê³„ ê°œí¸"ì€ ì»¨ì„¤íŒ…ì— í•´ë‹¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
- "ì‚°ì¬", "ì‚°ì—…ì•ˆì „", "ë‹¤ì¹¨", "ì§ˆë³‘", "ìš”ì–‘" ë“±ì€ ì‚°ì—…ì¬í•´ì— í•´ë‹¹í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.

ì•„ë˜ ë¬¸ì¥ì€ ì‹¤ì œ ê·¼ë¡œì/ì‚¬ì—…ì£¼ê°€ ì§ˆë¬¸í•œ ë‚´ìš©ì…ë‹ˆë‹¤.
ë¬¸ì¥ì˜ ë‰˜ì•™ìŠ¤ë¥¼ ì£¼ì˜ ê¹Šê²Œ ë¶„ì„í•˜ê³ , ì´ ë¬¸ì¥ì„ ê°€ì¥ ì˜ ì„¤ëª…í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ì„ íƒí•˜ì„¸ìš”:

- {chr(10).join(f"- {cat}" for cat in categories)}

ê·œì¹™:
- ë°˜ë“œì‹œ ìœ„ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
- ë‹¤ë¥¸ ë§ì€ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”.
- ë¶„ë¥˜ê°€ ì–´ë ¤ì›Œë„ ê°€ì¥ ìœ ì‚¬í•œ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.

ì˜ˆì‹œ:
{chr(10).join(examples)}

ì‚¬ìš©ì ë¬¸ì¥:
"{user_input}"

ğŸ‘‰ ì¹´í…Œê³ ë¦¬:"""

# ì¶œë ¥ ì •ì œ ë¡œì§
def clean_category_output(result: str) -> str:
    for cat in categories:
        if cat in result:
            return cat
    return "ë¶„ë¥˜ ì‹¤íŒ¨"

# ë¶„ë¥˜ í•¨ìˆ˜
def classify_text_with_openai(user_input: str) -> str:
    start = time.time()

    # âœ… ì¤‘ìš”í•œ ì˜¤ë‹µ í¬ì¸íŠ¸ëŠ” í•­ìƒ í¬í•¨
    core_examples = [
        '"ì´ìœ ë„ ëª¨ë¥´ê³  ì •ì§ ì²˜ë¶„ ë°›ì•˜ì–´ìš”" -> ë¶€ë‹¹ì§•ê³„',
        '"í•˜ë£¨ ì•„ì¹¨ì— ë‚˜ê°€ë¼ëŠ” í†µë³´ë¥¼ ë°›ì•˜ì–´ìš”" -> ë¶€ë‹¹í•´ê³ ',
        '"ìƒì‚¬ê°€ ìš•ì„¤ì„ í•©ë‹ˆë‹¤" -> ì§ì¥ë‚´ê´´ë¡­í˜',
        '"ìœ¡ì•„íœ´ì§ í›„ ë‹¤ë¥¸ ë¶€ì„œë¡œ ë°°ì¹˜í•´ë„ ë˜ë‚˜ìš”?" -> ì§ì¥ë‚´ì°¨ë³„',
        '"ì·¨ì—…ê·œì¹™ ê°œì •í•  ë•Œ í•„ìš”í•œ ì ˆì°¨ëŠ”?" -> ê¸°ì—…ìë¬¸',
    ]

    # âœ… ì¶”ê°€ë¡œ ëœë¤ ìƒ˜í”Œ
    examples = (
        core_examples +
        random.sample(business_examples, 2) +
        random.sample(worker_examples, 2) +
        random.sample(casual_examples, 2)
    )

    prompt = generate_prompt(user_input, examples, categories)

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3,
            max_tokens=50,
        )
        raw_result = response.choices[0].message.content.strip()
        print(f"ğŸ” Raw Output: {raw_result}")
        print(f"â±ï¸ GPT ì‘ë‹µ ì‹œê°„: {time.time() - start:.2f}ì´ˆ")

        cleaned = clean_category_output(raw_result)

        return cleaned
    except Exception as e:
        print("âŒ OpenAI API ì˜¤ë¥˜:", e)
        return "ë¶„ë¥˜ ì‹¤íŒ¨"

# FastAPI ì—”ë“œí¬ì¸íŠ¸
@router.post("/classify")
async def classify_endpoint(user_input: UserInput):
    result = classify_text_with_openai(user_input.text)

    # ìë™ì™„ì„± í‚¤ì›Œë“œ ë§¤ì¹­
    suggestions = autocomplete_map.get(result, [])

    return {
        "category": result,
        "suggestions": suggestions
    }